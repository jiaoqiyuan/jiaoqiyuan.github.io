<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/avatar-6.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, Jony">










<meta name="description" content="集群环境 操作系统：RedHat   内存：32G   Hadoop版本：2.7.6   Hive版本：1.2.2  有关Hadoop的安装，HDFS和YARN的配置可以参考我写的 配置本地Hadoop环境，另外Hive的常用函数可以参考我的另一篇文章 Hive常用函数总结 。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive的使用">
<meta property="og:url" content="http://yoursite.com/2019/01/08/Hive的使用/index.html">
<meta property="og:site_name" content="My Love">
<meta property="og:description" content="集群环境 操作系统：RedHat   内存：32G   Hadoop版本：2.7.6   Hive版本：1.2.2  有关Hadoop的安装，HDFS和YARN的配置可以参考我写的 配置本地Hadoop环境，另外Hive的常用函数可以参考我的另一篇文章 Hive常用函数总结 。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.tertiarycourses.com.sg/media/catalog/product/cache/1/image/512x/040ec09b1e35df139433887a97daa66f/a/p/apache-hive_1.jpg">
<meta property="og:updated_time" content="2020-04-27T03:00:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hive的使用">
<meta name="twitter:description" content="集群环境 操作系统：RedHat   内存：32G   Hadoop版本：2.7.6   Hive版本：1.2.2  有关Hadoop的安装，HDFS和YARN的配置可以参考我写的 配置本地Hadoop环境，另外Hive的常用函数可以参考我的另一篇文章 Hive常用函数总结 。">
<meta name="twitter:image" content="https://www.tertiarycourses.com.sg/media/catalog/product/cache/1/image/512x/040ec09b1e35df139433887a97daa66f/a/p/apache-hive_1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/08/Hive的使用/">





  <title>Hive的使用 | My Love</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/jiaoqiyuan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Love</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">I will be stronger</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-主页">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            主页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于我">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于我
          </a>
        </li>
      
        
        <li class="menu-item menu-item-标签">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-分类">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-归档">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/Hive的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jony Chiao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar-6.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Love">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hive的使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T05:30:31+08:00">
                2019-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/08/Hive的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2019/01/08/Hive的使用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  14.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  73
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox" href="https://www.tertiarycourses.com.sg/media/catalog/product/cache/1/image/512x/040ec09b1e35df139433887a97daa66f/a/p/apache-hive_1.jpg" rel="gallery_ckm0dqysw006dgfttd7aa3fai" itemscope itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="https://www.tertiarycourses.com.sg/media/catalog/product/cache/1/image/512x/040ec09b1e35df139433887a97daa66f/a/p/apache-hive_1.jpg" itemprop="contentUrl">
              </a>
            
          

          
          </div>
        </div>
      

      
        <h1 id="集群环境"><a href="#集群环境" class="headerlink" title="集群环境"></a>集群环境</h1><blockquote>
<p>操作系统：RedHat</p>
</blockquote>
<blockquote>
<p>内存：32G</p>
</blockquote>
<blockquote>
<p>Hadoop版本：2.7.6</p>
</blockquote>
<blockquote>
<p>Hive版本：1.2.2</p>
</blockquote>
<p>有关Hadoop的安装，HDFS和YARN的配置可以参考我写的 <a href="https://jiaoqiyuan.cn/2018/12/26/%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0Hadoop%E7%8E%AF%E5%A2%83/" target="_blank" rel="noopener">配置本地Hadoop环境</a>，另外Hive的常用函数可以参考我的另一篇文章 <a href="https://jiaoqiyuan.cn/2019/01/05/Hive%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">Hive常用函数总结</a> 。</p>
<a id="more"></a>
<h1 id="相关数据资源"><a href="#相关数据资源" class="headerlink" title="相关数据资源"></a>相关数据资源</h1><p>可以从我的<a href="https://pan.baidu.com/s/19dcVUGVagvNgyhwsULI3zg" target="_blank" rel="noopener">百度云盘这个地址</a>下载相关数据资源信息。然后将这些资源信息放到HDFS上，在后续创建Hive表的过程中根据你实际放置的HDFS路径修改location相关的内容即可。</p>
<h1 id="Hive解决了什么问题"><a href="#Hive解决了什么问题" class="headerlink" title="Hive解决了什么问题"></a>Hive解决了什么问题</h1><h2 id="从MR到Hive"><a href="#从MR到Hive" class="headerlink" title="从MR到Hive"></a>从MR到Hive</h2><p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/Hadoop%E7%94%9F%E6%80%81%E7%B3%BB%E7%BB%9F.png" alt="Hadoop生态系统"></p>
<p>Hadoop的核心是HDFS和MapReduce计算框架。HDFS是分布式文件系统，是Hadoop文件存储和管理的基础。MR是计算引擎，承担Hadoop下的计算任务。</p>
<p>Sqoop：是关系型数据库与Hadoop之间的数据传输工具。</p>
<p>FLume：是日志收集系统</p>
<p>Zookeeper：分布式协作服务</p>
<p>HBase：列存数据库</p>
<p>Mahout：用于数据挖掘</p>
<p>Pig：服务于流计算</p>
<p>Hive：数据仓库工具</p>
<p><strong>HDFS解决了文件分布式存储的问题。</strong></p>
<p><strong>MapReduce解决了数据处理分布式计算的问题</strong></p>
<p><strong>Hive解决了什么问题呢？—- 化繁为简</strong></p>
<p>Hive将开发人员从手写MapReduce程序的麻烦过程中解放出来，编写SQL程序即可完成MR任务。</p>
<h2 id="化繁为简的Hive"><a href="#化繁为简的Hive" class="headerlink" title="化繁为简的Hive"></a>化繁为简的Hive</h2><p><img src="http://hive.apache.org/images/hive_logo_medium.jpg" alt="Hive"></p>
<p>Hive所作的工作不是替代MapReduce，而是将SQL语句翻译成MapReduce任务执行，它提供了一个接口层，供用户使用SQL来调用MapReduce，这极大提高了数据分析人员和开发人员的工作效率。</p>
<h1 id="Hive擅长什么"><a href="#Hive擅长什么" class="headerlink" title="Hive擅长什么"></a>Hive擅长什么</h1><h2 id="Hive的优势"><a href="#Hive的优势" class="headerlink" title="Hive的优势"></a>Hive的优势</h2><ul>
<li><p>简单容易上手</p>
<p>  Hive使用类SQL语言，有关系型数据库使用经验的人都可以平滑过渡到Hive，非程序员也可以快速上手使用。</p>
</li>
<li><p>开发快速</p>
<p>  Hive清洗和分析数据的效率很高，Hive出现之前，数据处理工作需要交给熟悉MR程序的开发人员才能完成，而且MR程序的编写工作量非常大，Hive出现后，使用类SQL语言直接操作数据，大大提高了开发速度。</p>
</li>
<li><p>适合大规模数据的处理</p>
<p>  Hive最终会将SQL语句翻译成MR程序执行，所以它能处理大规模数据。</p>
</li>
</ul>
<h2 id="Hive的局限"><a href="#Hive的局限" class="headerlink" title="Hive的局限"></a>Hive的局限</h2><ul>
<li><p>延迟高</p>
<p>  即使数据量很小，也需要很长时间才能完成Hive的一个操作，这是由Hadoop执行引擎的特点决定的。</p>
</li>
<li><p>不支持DELETE/UPDATE等事务处理</p>
<p>  这是HDFS的特性决定的，HDFS适合一次写入多次读取的情况，因此不能通过Hive完成DELETE/UPDATE等事务处理操作。</p>
</li>
</ul>
<p><strong>Hive擅长的是非实时的、离线的、对响应及时性要求不高的海量数据批量计算</strong></p>
<h2 id="Hive的适用场景"><a href="#Hive的适用场景" class="headerlink" title="Hive的适用场景"></a>Hive的适用场景</h2><ul>
<li>海量日志分析</li>
</ul>
<p>日志数据量是非常庞大的，一个中型网站每天的日志数据量可达数十GB，这样的数据量式用单机处理会很吃力，需要式用分布式处理系统。另外日志数据产生后不会修改，满足Hive式用条件，一般情况下离线数据分析能满足很大一部分业务需求。</p>
<p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/%E6%B5%B7%E9%87%8F%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90.png" alt="海量日志分析"></p>
<p>日志数据通过flume收集到HDFS上，然后经过MR清洗（如清除一些异常日志），重新存放到HDFS，最后经过Hive处理和统计，为最终业务需要服务。</p>
<ul>
<li>海量结构化数据分析</li>
</ul>
<p>业务数据库中的表往往是针对线上业务而设计的，对统计分析需求往往并不友好，而且通常也不满足高并发量的需求。</p>
<p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/%E6%B5%B7%E9%87%8F%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90.png" alt="海量结构化数据分析"></p>
<p>要进行数据分析通常是先使用Sqoop工具将关系型数据库中的数据导入到HDFS，之后根据统计分析业务需要，通过Hive对数据进行处理，存储成方便后续业务分析的格式。这就是数据仓库的场景。</p>
<h2 id="Hive数据结构与数据仓库"><a href="#Hive数据结构与数据仓库" class="headerlink" title="Hive数据结构与数据仓库"></a>Hive数据结构与数据仓库</h2><h2 id="数据仓库"><a href="#数据仓库" class="headerlink" title="数据仓库"></a>数据仓库</h2><p>数据仓库是一个：<strong>面向主题的（Subject Oriented）、集成的（Integrated）、相对稳定的（Non-Volatile）、反映历史变化（Time Variant）</strong>的数据集合。用于支持管理层决策。</p>
<h2 id="传统数据仓库"><a href="#传统数据仓库" class="headerlink" title="传统数据仓库"></a>传统数据仓库</h2><p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93.png" alt="传统数据库"></p>
<p>早期数据仓库建立在数据库之上，依托中央数据库，由于中央数据库运行于单机上，存储、计算和扩展能力都受到严重制约，已经不满足现在数据处理的需求，数据达到PB级时，传统数据库基本无法获得很好的性能。</p>
<p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/Hive%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93.png" alt="Hive数据仓库"></p>
<p>Hive构建的数据仓库建立在Hadoop之上，将从数据源收集的数据会存放在HDFS后，Hive将HDFS上的数据映射为数据库，并以MapReduce任务的形式进行计算，为接下来的数据报表和分析提供服务。Hive可以满足大部分数据分析的需求，且拓展能力很强。</p>
<h2 id="Hive架构（3-1）"><a href="#Hive架构（3-1）" class="headerlink" title="Hive架构（3+1）"></a>Hive架构（3+1）</h2><p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/Hive%E6%9E%B6%E6%9E%84.png" alt="Hive架构"></p>
<ul>
<li><p>Hive组成模块：</p>
<ul>
<li><p>用户接口模块（User Interface）：用于实现对Hive的访问</p>
<ul>
<li><p>CLI：命令行方式</p>
</li>
<li><p>JDBC：提供java编程接口</p>
</li>
<li><p>HWI（HiveWebUI）：网页形式提供访问接口</p>
</li>
</ul>
</li>
<li><p>元数据模块（MetaStore）：是一个数据库，可以是Hive自带数据库也可是外部数据库，常用MySQL。Hive的数据存储格式可以由用户自己定义，元数据记录了数据存储的格式，对照元数据信息，Hive才能将HDFS上的数据映射为有意义的数据表。</p>
</li>
<li><p>驱动模块（Drivers）：驱动模块包括编译器、优化器、执行器等，负责将SQL语句转化成MapReduce任务。</p>
</li>
</ul>
</li>
<li><p>关联模块</p>
<ul>
<li>Hadoop：Hive并不能独立完成数据处理工作，它将SQL转化成MapReduce任务后交给Hadoop处理。</li>
</ul>
</li>
</ul>
<h2 id="Hive运行流程"><a href="#Hive运行流程" class="headerlink" title="Hive运行流程"></a>Hive运行流程</h2><p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/Hive%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="Hive运行流程"></p>
<ol>
<li><p>Hive通过用户接口获得用户提交的查询任务，将其交给Driver模块。</p>
</li>
<li><p>Driver模块利用解析器解析查询语句获得用户任务。</p>
</li>
<li><p>编译器根据用户任务到MetaStore查询元数据信息。</p>
</li>
<li><p>编译器获得云信息后对任务进行编译，生成逻辑查询计划。</p>
</li>
<li><p>之后编译器将逻辑查询计划转为物理执行计划</p>
</li>
<li><p>Driver模块最后将物理计划转交给Hadooop执行。</p>
</li>
<li><p>Hadoop将执行结果返回给Hive，Hive通过用户接口返回数据结果。</p>
</li>
</ol>
<h2 id="数据模型与元数据"><a href="#数据模型与元数据" class="headerlink" title="数据模型与元数据"></a>数据模型与元数据</h2><h2 id="Hive数据模型"><a href="#Hive数据模型" class="headerlink" title="Hive数据模型"></a>Hive数据模型</h2><ul>
<li><p>Hive数据模型包括：</p>
<ul>
<li><p>Database  数据库：Hive数据模型的概念等同于关系型数据库的schema，是数据库的组织和结构，描述了数据库的表、列、视图等对象的信息</p>
</li>
<li><p>Table     表：Hive中表的概念与关系型数据库中表的概念一致</p>
</li>
<li><p>Partition 分区：类似关系数据中的表分区，Hive中同一分区的数据会放到同一目录下，使用分区在一些条件下能够提高计算效率，同一分区的数据可以进一步划分为桶，类似于子分区。</p>
</li>
<li><p>Bucket    桶：分区的数据可以进一步划分为桶，类似于子分区。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>与关系数据库的区别在于Hive的表可以分为内部表和外部表</p>
<ul>
<li><p>内部表Drop的时候会删除HDFS上的数据，适用于中间表等不需要从外部导入数据的情况。</p>
</li>
<li><p>外部表Drop时候不会删除HDFS上的数据，适用于将外部数据映射到表中的源表。</p>
</li>
</ul>
</li>
</ul>
<h2 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h2><blockquote>
<p>描述数据的数据</p>
</blockquote>
<p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/%E5%85%83%E6%95%B0%E6%8D%AE.png" alt="元数据"></p>
<p>元数据是对具体数据的一种格式化，Hive将SQL翻译成MapReduce的过程需要结合元数据来完成，Hive的元数据存储在关系型数据库中，这个数据库可以是Hive自带的derby，也可以是外部的MySQL数据库。</p>
<h2 id="Hive元数据表"><a href="#Hive元数据表" class="headerlink" title="Hive元数据表"></a>Hive元数据表</h2><table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">VERSION</td>
<td style="text-align:center">存储Hive版本的元数据表</td>
</tr>
<tr>
<td style="text-align:center">DBS、DATABASE_PARAMS</td>
<td style="text-align:center">Hive数据库相关的源数据表</td>
</tr>
<tr>
<td style="text-align:center">TBLS、TBL_PRIVS、TABLE_PARAMS</td>
<td style="text-align:center">Hive表和视图相关的元数据表</td>
</tr>
<tr>
<td style="text-align:center">SDS、SD_PARAMS、SERDES、SERDE_PARAMS</td>
<td style="text-align:center">Hive文件存储信息相关的元数据表</td>
</tr>
</tbody>
</table>
<p>注：</p>
<p>DBS中存储Hive中所有数据库的基本信息。</p>
<p>DATABASE_PARAMS存储数据库的相关参数。</p>
<p>不太常用的源数据表</p>
<table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">COLUMNS_V2</td>
<td style="text-align:center">表字段相关元数据</td>
</tr>
<tr>
<td style="text-align:center">PARTITIONS、PARTITION_KEYS、PARTITION_KEY_VALS、PARTITION_PARAMS</td>
<td style="text-align:center">数据库权限信息表</td>
</tr>
<tr>
<td style="text-align:center">DB_PRIVS</td>
<td style="text-align:center">数据库权限信息表</td>
</tr>
<tr>
<td style="text-align:center">IDXS</td>
<td style="text-align:center">存储Hive索引相关元信息</td>
</tr>
<tr>
<td style="text-align:center">INDEX_PARAMS</td>
<td style="text-align:center">索引相关的属性信息</td>
</tr>
<tr>
<td style="text-align:center">TAB_COL_STATS</td>
<td style="text-align:center">表字段的统计信息</td>
</tr>
<tr>
<td style="text-align:center">TBL_COL_PRIVS</td>
<td style="text-align:center">表字段的授权信息</td>
</tr>
<tr>
<td style="text-align:center">PART_PRIVS</td>
<td style="text-align:center">分区的授权信息</td>
</tr>
<tr>
<td style="text-align:center">PART_COL_STATS</td>
<td style="text-align:center">分区字段的统计信息</td>
</tr>
<tr>
<td style="text-align:center">PART_COL_PRIVS</td>
<td style="text-align:center">分区字段的权限信息</td>
</tr>
<tr>
<td style="text-align:center">FUNCS</td>
<td style="text-align:center">用户注册的函数信息</td>
</tr>
<tr>
<td style="text-align:center">FUNC_RU</td>
<td style="text-align:center">用户注册函数的资源信息</td>
</tr>
</tbody>
</table>
<h1 id="Hive安装与配置"><a href="#Hive安装与配置" class="headerlink" title="Hive安装与配置"></a>Hive安装与配置</h1><h2 id="Hive安装依赖"><a href="#Hive安装依赖" class="headerlink" title="Hive安装依赖"></a>Hive安装依赖</h2><ul>
<li><p>Hadoop</p>
</li>
<li><p>元数据存储</p>
<ul>
<li><p>内嵌数据库Derby —-内嵌模式</p>
</li>
<li><p>外部数据库</p>
<ul>
<li><p>本地数据库  —-本地模式</p>
</li>
<li><p>远程数据库  —-远程模式</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>三种配置模式的特点和区别</p>
<ul>
<li><p>内嵌模式：内嵌的Derby数据库存储元数据，一次只能连接一个客户端</p>
</li>
<li><p>本地模式：外部数据库存储元数据，metastore服务和hive运行在同一个进程。</p>
</li>
<li><p>远程模式：外部数据库存储元数据，metastore服务和hive运行在不同的进程。</p>
</li>
</ul>
</li>
<li><p>在hive-site.xml中可以通过jdbcURL、驱动、用户名、密码等配置信息，设置不同的模式。</p>
</li>
<li><p>生产环境下一般使用远程模式，测试环境下一般使用内嵌模式。</p>
</li>
</ul>
<h2 id="Hive安装与配置-1"><a href="#Hive安装与配置-1" class="headerlink" title="Hive安装与配置"></a>Hive安装与配置</h2><ul>
<li>Hive安装包结构</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">文件夹</th>
<th style="text-align:center">存放内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">bin</td>
<td style="text-align:center">执行文件目录</td>
</tr>
<tr>
<td style="text-align:center">conf</td>
<td style="text-align:center">配置文件目录</td>
</tr>
<tr>
<td style="text-align:center">examples</td>
<td style="text-align:center">样例目录</td>
</tr>
<tr>
<td style="text-align:center">hcatalog</td>
<td style="text-align:center">表和数据管理层</td>
</tr>
<tr>
<td style="text-align:center">lib</td>
<td style="text-align:center">jar包目录</td>
</tr>
<tr>
<td style="text-align:center">scripts</td>
<td style="text-align:center">数据库脚本目录</td>
</tr>
<tr>
<td style="text-align:center">LICENSE</td>
<td style="text-align:center">许可文件</td>
</tr>
<tr>
<td style="text-align:center">NOTICE</td>
<td style="text-align:center">版本信息</td>
</tr>
<tr>
<td style="text-align:center">README.txt</td>
<td style="text-align:center">说明文件</td>
</tr>
<tr>
<td style="text-align:center">RELEASE_NOTES.txt</td>
<td style="text-align:center">更新历史</td>
</tr>
</tbody>
</table>
<ul>
<li><p>Hive Cli启动流程</p>
<ol>
<li><p>bin/hive-config.sh初始化配置信息</p>
</li>
<li><p>conf/hive-env.sh初始化一些环境变量</p>
</li>
<li><p>检查hive-exec-*.jar, hive-metastore-*.jar, hive-cli-*.jar几个主要jar包是否存在。</p>
</li>
<li><p>添加hadoop相关classpath</p>
</li>
<li><p>执行lib/hive-service-x.x.x.jar</p>
</li>
</ol>
</li>
<li><p>下载、解压、重命名Hive</p>
  <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1015146591</span><span class="variable">@bigdata4</span> apps]<span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/mirrors.tuna.tsinghua.edu.cn/apache</span><span class="regexp">/hive/hive</span>-<span class="number">1.2</span>.<span class="number">2</span>/apache-hive-<span class="number">1.2</span>.<span class="number">2</span>-bin.tar.gz</span><br><span class="line">[<span class="number">1015146591</span><span class="variable">@bigdata4</span> apps]<span class="variable">$ </span>tar xzvf apache-hive-<span class="number">1.2</span>.<span class="number">2</span>-bin.tar.gz -C /mnt/home/<span class="number">1015146591</span>/apps</span><br><span class="line">[<span class="number">1015146591</span><span class="variable">@bigdata4</span> apps]<span class="variable">$ </span>mv apache-hive-<span class="number">1.2</span>.<span class="number">2</span>-bin/ hive-<span class="number">1.2</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件conf/hive-env.sh（<strong>这里主要是配置HADOOP_HOME，如果之前配置过HADOOP_HOME，这里无需配置hive-env.sh</strong>），配置HADOOP_HOME。</p>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将改行注释去掉，配置正确的Hadoop目录即可</span></span><br><span class="line"><span class="attr">HADOOP_HOME</span>=<span class="variable">$&#123;bin&#125;</span>/../../hadoop</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置conf/hive-site.xml（hive-site.xml的优先级高于hive-default.xml的优先级，两者共有的字段只有hive-site.xml中的配置生效）</p>
<p>  复制hive-default.xml.template为hive-site.xml，在configuration中最后添加两个property</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;system:java.io.tmpdir&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/mnt/home/1015146591/apps/hive-1.2.2/tmp&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;system:user.name&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;1015146591&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
<p>  另外修改一下hive-site.xml中hive.metastore.warehouse.dir的值，这个值表示回头你创建的数据库在HDFS上的存放位置：</p>
  <figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">    <span class="params">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">    <span class="params">&lt;value&gt;</span><span class="meta-keyword">/user/</span><span class="number">1015146591</span>/warehouse<span class="params">&lt;/value&gt;</span></span><br><span class="line">    <span class="params">&lt;description&gt;</span>location of default database for the warehouse<span class="params">&lt;/description&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动hive（z在hive目录下启动）</p>
  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/bin/</span>hive</span><br></pre></td></tr></table></figure>
  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; show databases;</span><br><span class="line">OK</span><br><span class="line">default</span><br><span class="line">Time taken: 1.293 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="创建和管理Hive中的数据"><a href="#创建和管理Hive中的数据" class="headerlink" title="创建和管理Hive中的数据"></a>创建和管理Hive中的数据</h1><h2 id="Hive中创建数据库"><a href="#Hive中创建数据库" class="headerlink" title="Hive中创建数据库"></a>Hive中创建数据库</h2><ul>
<li><p>最简单的创建数据库方法：</p>
  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; create database bigdata;</span><br><span class="line">OK</span><br><span class="line">Time taken: 0.065 seconds</span><br><span class="line">hive&gt; show databases;</span><br><span class="line">OK</span><br><span class="line">bigdata</span><br><span class="line">default</span><br><span class="line">Time taken: 0.01 seconds, Fetched: 2 row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>重复创建数据库会报错：</p>
  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hive</span>&gt; <span class="selector-tag">create</span> <span class="selector-tag">database</span> <span class="selector-tag">bigdata</span>;</span><br><span class="line"><span class="selector-tag">FAILED</span>: <span class="selector-tag">Execution</span> <span class="selector-tag">Error</span>, <span class="selector-tag">return</span> <span class="selector-tag">code</span> 1 <span class="selector-tag">from</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hive</span><span class="selector-class">.ql</span><span class="selector-class">.exec</span><span class="selector-class">.DDLTask</span>. <span class="selector-tag">Database</span> <span class="selector-tag">bigdata</span> <span class="selector-tag">already</span> <span class="selector-tag">exists</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更严谨的做法是：</p>
  <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> bigdata;</span><br><span class="line">OK</span><br><span class="line">Time taken: 0.013 seconds</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除一个数据库</p>
  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; drop database <span class="keyword">if</span> exists bigdata;</span><br><span class="line">OK</span><br><span class="line">Time taken: 0.327 seconds</span><br><span class="line">hive&gt; show databases;</span><br><span class="line">OK</span><br><span class="line">default</span><br><span class="line">Time taken: 0.018 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建外部表</p>
<ul>
<li><p>拷贝json解析包到hive目录下的lib</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /tmp/hivecourse/json-serde-<span class="number">1.3</span>.<span class="number">6</span>-jar-<span class="keyword">with</span>-dependencies.jar /mnt/home/<span class="number">1015146591</span>/apps/hive-<span class="number">1.2</span>.<span class="number">2</span>/<span class="class"><span class="keyword">lib</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在Hive文件中增加该jar包配置</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.aux.jars.path&lt;<span class="regexp">/name&gt;</span></span><br><span class="line"><span class="regexp">    &lt;value&gt;file:/</span><span class="regexp">//mnt</span><span class="regexp">/home/</span><span class="number">1015146591</span>/apps/hive-<span class="number">1.2</span>.<span class="number">2</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">json</span>-<span class="title">serde</span>-1.3.6-<span class="title">jar</span>-<span class="title">with</span>-<span class="title">dependencies</span>.<span class="title">jar</span>&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">&lt;<span class="regexp">/property&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Hive数据表，建表语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`bigdata.weblog`</span> (</span><br><span class="line">    <span class="string">`time_tag`</span>      <span class="built_in">bigint</span>      <span class="keyword">COMMENT</span> <span class="string">'时间'</span>,</span><br><span class="line">    <span class="string">`active_name`</span>   <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'事件名称'</span>,</span><br><span class="line">    <span class="string">`device_id`</span>     <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'设备id'</span>,</span><br><span class="line">    <span class="string">`session_id`</span>    <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'会话id'</span>,</span><br><span class="line">    <span class="string">`user_id`</span>       <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">    <span class="string">`ip`</span>            <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'ip地址'</span>,</span><br><span class="line">    <span class="string">`address`</span>       <span class="keyword">map</span>&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; <span class="keyword">COMMENT</span> <span class="string">'地址'</span>,</span><br><span class="line">    <span class="string">`req_url`</span>       <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'http请求地址'</span>,</span><br><span class="line">    <span class="string">`action_path`</span>   <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;   <span class="keyword">COMMENT</span> <span class="string">'访问路径'</span>,</span><br><span class="line">    <span class="string">`product_id`</span>    <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">    <span class="string">`order_id`</span>      <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'订单id'</span></span><br><span class="line">) PARTITIONED <span class="keyword">BY</span>(</span><br><span class="line">    <span class="string">`day`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'日期'</span></span><br><span class="line">) <span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE</span><br><span class="line">    <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">LOCATION</span><br><span class="line">    <span class="string">'/user/hadoop/weblog'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加分区指令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-05-29'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-05-29'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-05-30'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-05-30'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-05-31'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-05-31'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-01'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-01'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-02'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-02'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-03'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-03'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-04'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-04'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-05'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-05'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-06'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-06'</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> bigdata.weblog <span class="keyword">add</span> <span class="keyword">partition</span> (<span class="keyword">day</span>=<span class="string">'2018-06-07'</span>) location <span class="string">'/user/hadoop/weblog/day=2018-06-07'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="配置hive使用mysql存储元数据"><a href="#配置hive使用mysql存储元数据" class="headerlink" title="配置hive使用mysql存储元数据"></a>配置hive使用mysql存储元数据</h2><p>修改hive-site.xml，将下面的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--JDBC元数据仓库连接字符串--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:derby:;databaseName=metastore_db;create=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--JDBC元数据仓库驱动类名--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.derby.jdbc.EmbeddedDriver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--元数据仓库用户名--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>APP<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Username to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--元数据仓库密码--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>mine<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>password to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>替换成下面的内容，需要提前将mysql的驱动下载并放到hive的lib目录下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>password to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://bigdata5:3306/hive_meta?createDatabaseIfNotExist=true&amp;amp;useSSL=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Username to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据实际情况填写mysql的ip，然后运行hive即可。</p>
<h1 id="写一个基本的查询语句"><a href="#写一个基本的查询语句" class="headerlink" title="写一个基本的查询语句"></a>写一个基本的查询语句</h1><h2 id="SELECT的用法"><a href="#SELECT的用法" class="headerlink" title="SELECT的用法"></a>SELECT的用法</h2><ul>
<li><p>用户（user_id）访问了什么网页（req_url）？</p>
  <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> time_tag, user_id, req_url <span class="keyword">from</span> bigdata.weblog <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>  查询结果：</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select time_tag, user_id, req_url from bigdata.weblog limit <span class="number">10</span>;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1527604188966</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527604410990</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527604638195</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527604714462</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527604879475</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527604964330</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527605154014</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527605190626</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527605398767</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438747116</span></span><br><span class="line"><span class="number">1527605466969</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438747157</span></span><br><span class="line">Time <span class="string">taken:</span> <span class="number">0.062</span> seconds, <span class="string">Fetched:</span> <span class="number">10</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="WHERE的用法"><a href="#WHERE的用法" class="headerlink" title="WHERE的用法"></a>WHERE的用法</h2><ul>
<li><p>用户(user_id=xxx)访问了什么网页(req_url)?</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> time_tag, user_id, req_url <span class="keyword">from</span> bigdata.weblog <span class="keyword">where</span> user_id=<span class="string">'4921528165744221'</span> <span class="keyword">and</span> <span class="keyword">day</span>=<span class="string">'2018-05-29'</span>;</span><br></pre></td></tr></table></figure>
<p>  查询结果：</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select time_tag, user_id, req_url from bigdata.weblog where user_id=<span class="string">'4921528165744221'</span> and day=<span class="string">'2018-05-29'</span>;</span><br><span class="line">OK</span><br><span class="line"><span class="number">1527604188966</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527604410990</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527604638195</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527604714462</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527604879475</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527604964330</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527605154014</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527605190626</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527605398767</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438747116</span></span><br><span class="line"><span class="number">1527605466969</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438747157</span></span><br><span class="line"><span class="number">1527605536435</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438748068</span></span><br><span class="line"><span class="number">1527605740447</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527594315438</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527594532642</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527594630140</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527594739145</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527594794926</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527594987391</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527595196976</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527595391276</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527595503065</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527595691945</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438748291</span></span><br><span class="line"><span class="number">1527595920306</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438747370</span></span><br><span class="line"><span class="number">1527596123417</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/category</span></span><br><span class="line"><span class="number">1527596236662</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line"><span class="number">1527596475796</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438748068</span></span><br><span class="line"><span class="number">1527596643269</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438749679</span></span><br><span class="line"><span class="number">1527596673093</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527596857131</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com</span></span><br><span class="line"><span class="number">1527596882285</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438748572</span></span><br><span class="line"><span class="number">1527597101997</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/product/1527235438746733</span></span><br><span class="line"><span class="number">1527597158210</span>   <span class="number">4921528165744221</span>        <span class="string">http:</span><span class="comment">//www.bigdataclass.com/my/4921528165744221</span></span><br><span class="line">Time <span class="string">taken:</span> <span class="number">0.231</span> seconds, <span class="string">Fetched:</span> <span class="number">32</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="子查询和关联表"><a href="#子查询和关联表" class="headerlink" title="子查询和关联表"></a>子查询和关联表</h1><h2 id="关联表JOIN"><a href="#关联表JOIN" class="headerlink" title="关联表JOIN"></a>关联表JOIN</h2><ul>
<li><p>下单用户是谁？如果获取更多信息</p>
<ul>
<li><p>创建一个用户表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`bigdata.member`</span> (</span><br><span class="line">    <span class="string">`user_id`</span>       <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">    <span class="string">`nick_name`</span>     <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">    <span class="string">`name`</span>          <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">    <span class="string">`gender`</span>        <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'性别'</span>,</span><br><span class="line">    <span class="string">`register_time`</span>   <span class="built_in">bigint</span>    <span class="keyword">COMMENT</span> <span class="string">'注册时间'</span>,</span><br><span class="line">    <span class="string">`birthday`</span>      <span class="built_in">bigint</span>      <span class="keyword">COMMENT</span> <span class="string">'生日'</span>,</span><br><span class="line">    <span class="string">`device_type`</span>   <span class="keyword">string</span>      <span class="keyword">COMMENT</span> <span class="string">'设备类型'</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE</span><br><span class="line">    <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">LOCATION</span><br><span class="line">    <span class="string">'/user/hadoop/hive/member'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行结果：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">hive</span>&gt; desc member<span class="comment">;</span></span><br><span class="line"><span class="symbol">OK</span></span><br><span class="line"><span class="symbol">user_id</span>                 <span class="keyword">string </span>                 用户id</span><br><span class="line"><span class="symbol">nick_name</span>               <span class="keyword">string </span>                 昵称</span><br><span class="line"><span class="symbol">name</span>                    <span class="keyword">string </span>                 姓名</span><br><span class="line"><span class="symbol">gender</span>                  <span class="keyword">string </span>                 性别</span><br><span class="line"><span class="symbol">register_time</span>           <span class="keyword">bigint </span>                 注册时间</span><br><span class="line"><span class="keyword">birthday </span>               <span class="keyword">bigint </span>                 生日</span><br><span class="line"><span class="symbol">device_type</span>             <span class="keyword">string </span>                 设备类型</span><br><span class="line"><span class="symbol">Time</span> taken: <span class="number">0</span>.<span class="number">05</span> seconds, Fetched: <span class="number">7</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联用户表信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.user_id,</span><br><span class="line">    gender,</span><br><span class="line">    register_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id <span class="keyword">from</span> bigdata.weblog <span class="keyword">where</span> active_name=<span class="string">'order'</span>) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> user_id, gender, register_time <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id </span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select</span><br><span class="line">    &gt;     t1.user_id,</span><br><span class="line">    &gt;     gender,</span><br><span class="line">    &gt;     register_time</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt; (select user_id from bigdata.weblog where active_name='order') t1</span><br><span class="line">    &gt; join</span><br><span class="line">    &gt; (select user_id, gender, register_time from bigdata.member) t2</span><br><span class="line">    &gt; on t1.user_id=t2.user_id limit 10;</span><br><span class="line">Query ID = 1015146591_20190106140901_6897753b<span class="string">-2</span>c29<span class="string">-4</span>c81<span class="string">-9</span>aaa-c03876e46e1e</span><br><span class="line">Total jobs = 1</span><br><span class="line">Execution log at: /tmp/1015146591/1015146591_20190106140901_6897753b<span class="string">-2</span>c29<span class="string">-4</span>c81<span class="string">-9</span>aaa-c03876e46e1e.log</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:05     Starting to launch local task to process map join;      maximum memory = 508559360</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:06     Dump the side-table for tag: 1 with group count: 30179 into file: file:/mnt/home/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56a2b2ad-eab4<span class="string">-4</span>e0a-a49d-f0bfd62e96fc/hive_2019<span class="string">-01</span><span class="string">-06</span>_14<span class="string">-09</span><span class="string">-01</span>_666_424795490568777106<span class="string">-1</span>/-local<span class="string">-10003</span>/HashTable-Stage<span class="string">-3</span>/MapJoin-mapfile11--.hashtable</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:06     Uploaded 1 File to: file:/mnt/home/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56a2b2ad-eab4<span class="string">-4</span>e0a-a49d-f0bfd62e96fc/hive_2019<span class="string">-01</span><span class="string">-06</span>_14<span class="string">-09</span><span class="string">-01</span>_666_424795490568777106<span class="string">-1</span>/-local<span class="string">-10003</span>/HashTable-Stage<span class="string">-3</span>/MapJoin-mapfile11--.hashtable (1395272 bytes)</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:06     End of local task; Time Taken: 1.491 sec.</span><br><span class="line">Execution completed successfully</span><br><span class="line">MapredLocal task succeeded</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks is set to 0 since there's no reduce operator</span><br><span class="line">Starting Job = job_1535253853575_21356, Tracking URL = http://bigdata0.novalocal:8088/proxy/application_1535253853575_21356/</span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21356</span><br><span class="line">Hadoop job information for Stage<span class="string">-3</span>: number of mappers: 6; number of reducers: 0</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:13,778 Stage<span class="string">-3</span> map = 0%,  reduce = 0%</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:21,078 Stage<span class="string">-3</span> map = 33%,  reduce = 0%, Cumulative CPU 8.53 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:23,137 Stage<span class="string">-3</span> map = 50%,  reduce = 0%, Cumulative CPU 16.27 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:25,224 Stage<span class="string">-3</span> map = 54%,  reduce = 0%, Cumulative CPU 48.62 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:28,319 Stage<span class="string">-3</span> map = 69%,  reduce = 0%, Cumulative CPU 58.85 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:30,379 Stage<span class="string">-3</span> map = 77%,  reduce = 0%, Cumulative CPU 62.09 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:31,412 Stage<span class="string">-3</span> map = 78%,  reduce = 0%, Cumulative CPU 68.57 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:32,465 Stage<span class="string">-3</span> map = 86%,  reduce = 0%, Cumulative CPU 69.58 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:34,543 Stage<span class="string">-3</span> map = 93%,  reduce = 0%, Cumulative CPU 75.94 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:09:36,615 Stage<span class="string">-3</span> map = 100%,  reduce = 0%, Cumulative CPU 78.36 sec</span><br><span class="line">MapReduce Total cumulative CPU time: 1 minutes 18 seconds 360 msec</span><br><span class="line">Ended Job = job_1535253853575_21356</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage<span class="string">-3</span>: Map: 6   Cumulative CPU: 78.36 sec   HDFS Read: 942484283 HDFS Write: 760 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 1 minutes 18 seconds 360 msec</span><br><span class="line">OK</span><br><span class="line">8201531897436759        男      1526031234916</span><br><span class="line">2211531897362630        男      1519311748534</span><br><span class="line">8431531897389241        男      1520079723099</span><br><span class="line">3211531897369709        男      1523560308175</span><br><span class="line">6911531897308202        女      1525233502748</span><br><span class="line">5041531897225960        男      1527678449938</span><br><span class="line">7391531897436409        女      1527670790734</span><br><span class="line">8191531897363226        男      1526696249998</span><br><span class="line">0851531897431904        女      1524085244386</span><br><span class="line">7031531897150536        女      1527243924519</span><br><span class="line">Time taken: 36.225 seconds, Fetched: 10 row(s)</span><br><span class="line">hive&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.user_id,</span><br><span class="line">    gender,</span><br><span class="line">    register_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id <span class="keyword">from</span> bigdata.weblog <span class="keyword">where</span> active_name=<span class="string">'order'</span>) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> user_id, gender, register_time <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>这里t1、t2是子查询的别名，两个子查询语句通过公共字段进行关联。</p>
<p>join分四种情况</p>
<p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/Join%E5%88%86%E7%B1%BB.png" alt="Join分类"></p>
<h1 id="使用简单函数"><a href="#使用简单函数" class="headerlink" title="使用简单函数"></a>使用简单函数</h1><h2 id="Hive函数分类"><a href="#Hive函数分类" class="headerlink" title="Hive函数分类"></a>Hive函数分类</h2><ul>
<li><p>内置函数：hive自带的函数</p>
<ul>
<li><p><strong>简单函数</strong>：一进一出，用于格式化、数据运算等</p>
</li>
<li><p>聚合函数：多进一出，用于统计计算、指标聚合等</p>
</li>
<li><p>集合函数：array、map操作</p>
</li>
<li><p>特殊函数：窗口函数等</p>
</li>
</ul>
</li>
<li><p>自定义函数</p>
</li>
</ul>
<h2 id="简单函数"><a href="#简单函数" class="headerlink" title="简单函数"></a>简单函数</h2><ul>
<li><p>时间戳转换函数from_unixtime()</p>
<p>  前一节获取的数据t1.user_id, gender, register_time，其中register_time是时间戳格式，方便给机器读，但是不利于人阅读。</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.user_id,</span><br><span class="line">    gender,</span><br><span class="line">    from_unixtime(<span class="keyword">cast</span>(register_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>), <span class="string">'yyyy-MM-dd HH:mm:ss'</span>) <span class="keyword">as</span> register_day</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id <span class="keyword">from</span> bigdata.weblog <span class="keyword">where</span> active_name=<span class="string">'order'</span>) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> user_id, gender, register_time <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>  运行结果：</p>
  <figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select</span><br><span class="line">    &gt;     t1.user_id,</span><br><span class="line">    &gt;     gender,</span><br><span class="line">    &gt;     from_unixtime(cast(register_time/1000 as bigint), 'yyyy-MM-dd HH:mm:ss') as register_day</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt; (select user_id from bigdata.weblog where active_name='order') t1</span><br><span class="line">    &gt; join</span><br><span class="line">    &gt; (select user_id, gender, register_time from bigdata.member) t2</span><br><span class="line">    &gt; on t1.user_id=t2.user_id limit 10;</span><br><span class="line">Query ID = 1015146591_20190106145912_357aaca8-c7cf<span class="string">-4573</span>-b078-f8656f24c59d</span><br><span class="line">Total jobs = 1</span><br><span class="line">Execution log at: /tmp/1015146591/1015146591_20190106145912_357aaca8-c7cf<span class="string">-4573</span>-b078-f8656f24c59d.log</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:16     Starting to launch local task to process map join;      maximum memory = 508559360</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:19     Dump the side-table for tag: 1 with group count: 30179 into file: file:/mnt/home/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56a2b2ad-eab4<span class="string">-4</span>e0a-a49d-f0bfd62e96fc/hive_2019<span class="string">-01</span><span class="string">-06</span>_14<span class="string">-59</span><span class="string">-12</span>_260_600547876088340954<span class="string">-1</span>/-local<span class="string">-10003</span>/HashTable-Stage<span class="string">-3</span>/MapJoin-mapfile21--.hashtable</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:19     Uploaded 1 File to: file:/mnt/home/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56a2b2ad-eab4<span class="string">-4</span>e0a-a49d-f0bfd62e96fc/hive_2019<span class="string">-01</span><span class="string">-06</span>_14<span class="string">-59</span><span class="string">-12</span>_260_600547876088340954<span class="string">-1</span>/-local<span class="string">-10003</span>/HashTable-Stage<span class="string">-3</span>/MapJoin-mapfile21--.hashtable (1395272 bytes)</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:19     End of local task; Time Taken: 2.183 sec.</span><br><span class="line">Execution completed successfully</span><br><span class="line">MapredLocal task succeeded</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks is set to 0 since there's no reduce operator</span><br><span class="line">Starting Job = job_1535253853575_21357, Tracking URL = http://bigdata0.novalocal:8088/proxy/application_1535253853575_21357/</span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21357</span><br><span class="line">Hadoop job information for Stage<span class="string">-3</span>: number of mappers: 6; number of reducers: 0</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:28,200 Stage<span class="string">-3</span> map = 0%,  reduce = 0%</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:33,542 Stage<span class="string">-3</span> map = 33%,  reduce = 0%, Cumulative CPU 9.1 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:35,690 Stage<span class="string">-3</span> map = 50%,  reduce = 0%, Cumulative CPU 16.09 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:37,769 Stage<span class="string">-3</span> map = 51%,  reduce = 0%, Cumulative CPU 27.57 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:38,796 Stage<span class="string">-3</span> map = 54%,  reduce = 0%, Cumulative CPU 49.7 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:40,912 Stage<span class="string">-3</span> map = 61%,  reduce = 0%, Cumulative CPU 53.04 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:41,946 Stage<span class="string">-3</span> map = 69%,  reduce = 0%, Cumulative CPU 59.86 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:43,998 Stage<span class="string">-3</span> map = 78%,  reduce = 0%, Cumulative CPU 66.35 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:46,161 Stage<span class="string">-3</span> map = 86%,  reduce = 0%, Cumulative CPU 70.27 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:47,187 Stage<span class="string">-3</span> map = 93%,  reduce = 0%, Cumulative CPU 76.48 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 14:59:50,264 Stage<span class="string">-3</span> map = 100%,  reduce = 0%, Cumulative CPU 78.99 sec</span><br><span class="line">MapReduce Total cumulative CPU time: 1 minutes 18 seconds 990 msec</span><br><span class="line">Ended Job = job_1535253853575_21357</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage<span class="string">-3</span>: Map: 6   Cumulative CPU: 78.99 sec   HDFS Read: 942488681 HDFS Write: 880 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 1 minutes 18 seconds 990 msec</span><br><span class="line">OK</span><br><span class="line">8201531897436759        男      2018<span class="string">-05</span><span class="string">-11</span> 17:33:54</span><br><span class="line">2211531897362630        男      2018<span class="string">-02</span><span class="string">-22</span> 23:02:28</span><br><span class="line">8431531897389241        男      2018<span class="string">-03</span><span class="string">-03</span> 20:22:03</span><br><span class="line">3211531897369709        男      2018<span class="string">-04</span><span class="string">-13</span> 03:11:48</span><br><span class="line">6911531897308202        女      2018<span class="string">-05</span><span class="string">-02</span> 11:58:22</span><br><span class="line">5041531897225960        男      2018<span class="string">-05</span><span class="string">-30</span> 19:07:29</span><br><span class="line">7391531897436409        女      2018<span class="string">-05</span><span class="string">-30</span> 16:59:50</span><br><span class="line">8191531897363226        男      2018<span class="string">-05</span><span class="string">-19</span> 10:17:29</span><br><span class="line">0851531897431904        女      2018<span class="string">-04</span><span class="string">-19</span> 05:00:44</span><br><span class="line">7031531897150536        女      2018<span class="string">-05</span><span class="string">-25</span> 18:25:24</span><br><span class="line">Time taken: 39.182 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>日期函数：from_unixtime, unit_timestamp, to_date, date_diff ……</p>
</li>
<li><p>字符串函数：concat, concat_ws, format_number, upper/lower, parse_url ……</p>
</li>
<li><p>条件函数：if, case……when……</p>
</li>
<li><p>数学函数：round/ceil/floor, log, power, rand……</p>
</li>
</ul>
<h2 id="Hive自带函数"><a href="#Hive自带函数" class="headerlink" title="Hive自带函数"></a>Hive自带函数</h2><ul>
<li><p>查看Hive自带函数：</p>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; show functions;</span><br><span class="line">OK</span><br><span class="line">!</span><br><span class="line">!=</span><br><span class="line">%</span><br><span class="line">&amp;</span><br><span class="line"><span class="comment">*</span></span><br><span class="line">+</span><br><span class="line">-</span><br><span class="line">/</span><br><span class="line">&lt;</span><br><span class="line">&lt;=</span><br><span class="line">&lt;=&gt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">=</span><br><span class="line">==</span><br><span class="line">&gt;</span><br><span class="line">&gt;=</span><br><span class="line">^</span><br><span class="line"><span class="built_in">abs</span></span><br><span class="line"><span class="built_in">acos</span></span><br><span class="line">add_months</span><br><span class="line">and</span><br><span class="line">array</span><br><span class="line">array_contains</span><br><span class="line">ascii</span><br><span class="line"><span class="built_in">asin</span></span><br><span class="line">assert_true</span><br><span class="line"><span class="built_in">atan</span></span><br><span class="line">avg</span><br><span class="line">base64</span><br><span class="line">between</span><br><span class="line">bin</span><br><span class="line">case</span><br><span class="line">cbrt</span><br><span class="line"><span class="built_in">ceil</span></span><br><span class="line">ceiling</span><br><span class="line">coalesce</span><br><span class="line">collect_list</span><br><span class="line">collect_set</span><br><span class="line">compute_stats</span><br><span class="line">concat</span><br><span class="line">concat_ws</span><br><span class="line">context_ngrams</span><br><span class="line">conv</span><br><span class="line"><span class="built_in">corr</span></span><br><span class="line"><span class="built_in">cos</span></span><br><span class="line"><span class="keyword">count</span></span><br><span class="line">covar_pop</span><br><span class="line">covar_samp</span><br><span class="line">create_union</span><br><span class="line">cume_dist</span><br><span class="line">current_database</span><br><span class="line">current_date</span><br><span class="line">current_timestamp</span><br><span class="line">current_user</span><br><span class="line">date_add</span><br><span class="line">date_format</span><br><span class="line">date_sub</span><br><span class="line">datediff</span><br><span class="line"><span class="built_in">day</span></span><br><span class="line">dayofmonth</span><br><span class="line"><span class="keyword">decode</span></span><br><span class="line">degrees</span><br><span class="line">dense_rank</span><br><span class="line">div</span><br><span class="line"><span class="built_in">e</span></span><br><span class="line">elt</span><br><span class="line"><span class="keyword">encode</span></span><br><span class="line">ewah_bitmap</span><br><span class="line">ewah_bitmap_and</span><br><span class="line">ewah_bitmap_empty</span><br><span class="line">ewah_bitmap_or</span><br><span class="line"><span class="built_in">exp</span></span><br><span class="line">explode</span><br><span class="line">factorial</span><br><span class="line">field</span><br><span class="line">find_in_set</span><br><span class="line">first_value</span><br><span class="line"><span class="built_in">floor</span></span><br><span class="line">format_number</span><br><span class="line">from_unixtime</span><br><span class="line">from_utc_timestamp</span><br><span class="line">get_json_object</span><br><span class="line">greatest</span><br><span class="line">hash</span><br><span class="line">hex</span><br><span class="line">histogram_numeric</span><br><span class="line">hour</span><br><span class="line"><span class="keyword">if</span></span><br><span class="line"><span class="keyword">in</span></span><br><span class="line">in_file</span><br><span class="line"><span class="built_in">index</span></span><br><span class="line">initcap</span><br><span class="line">inline</span><br><span class="line">instr</span><br><span class="line">isnotnull</span><br><span class="line">isnull</span><br><span class="line">java_method</span><br><span class="line">json_tuple</span><br><span class="line">lag</span><br><span class="line">last_day</span><br><span class="line">last_value</span><br><span class="line">lcase</span><br><span class="line">lead</span><br><span class="line">least</span><br><span class="line"><span class="built_in">length</span></span><br><span class="line">levenshtein</span><br><span class="line">like</span><br><span class="line"><span class="built_in">ln</span></span><br><span class="line">locate</span><br><span class="line"><span class="built_in">log</span></span><br><span class="line"><span class="built_in">log10</span></span><br><span class="line">log2</span><br><span class="line"><span class="built_in">lower</span></span><br><span class="line">lpad</span><br><span class="line"><span class="built_in">ltrim</span></span><br><span class="line">map</span><br><span class="line">map_keys</span><br><span class="line">map_values</span><br><span class="line">matchpath</span><br><span class="line"><span class="built_in">max</span></span><br><span class="line"><span class="built_in">min</span></span><br><span class="line">minute</span><br><span class="line"><span class="built_in">month</span></span><br><span class="line">months_between</span><br><span class="line">named_struct</span><br><span class="line">negative</span><br><span class="line">next_day</span><br><span class="line">ngrams</span><br><span class="line">noop</span><br><span class="line">noopstreaming</span><br><span class="line">noopwithmap</span><br><span class="line">noopwithmapstreaming</span><br><span class="line">not</span><br><span class="line">ntile</span><br><span class="line">nvl</span><br><span class="line">or</span><br><span class="line">parse_url</span><br><span class="line">parse_url_tuple</span><br><span class="line">percent_rank</span><br><span class="line">percentile</span><br><span class="line">percentile_approx</span><br><span class="line">pi</span><br><span class="line">pmod</span><br><span class="line">posexplode</span><br><span class="line">positive</span><br><span class="line">pow</span><br><span class="line">power</span><br><span class="line">printf</span><br><span class="line">radians</span><br><span class="line">rand</span><br><span class="line">rank</span><br><span class="line">reflect</span><br><span class="line">reflect2</span><br><span class="line">regexp</span><br><span class="line">regexp_extract</span><br><span class="line">regexp_replace</span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line"><span class="built_in">reverse</span></span><br><span class="line">rlike</span><br><span class="line"><span class="built_in">round</span></span><br><span class="line">row_number</span><br><span class="line">rpad</span><br><span class="line"><span class="built_in">rtrim</span></span><br><span class="line">second</span><br><span class="line">sentences</span><br><span class="line">shiftleft</span><br><span class="line">shiftright</span><br><span class="line">shiftrightunsigned</span><br><span class="line"><span class="built_in">sign</span></span><br><span class="line"><span class="built_in">sin</span></span><br><span class="line">size</span><br><span class="line">sort_array</span><br><span class="line">soundex</span><br><span class="line">space</span><br><span class="line"><span class="keyword">split</span></span><br><span class="line"><span class="built_in">sqrt</span></span><br><span class="line"><span class="keyword">stack</span></span><br><span class="line">std</span><br><span class="line">stddev</span><br><span class="line">stddev_pop</span><br><span class="line">stddev_samp</span><br><span class="line">str_to_map</span><br><span class="line">struct</span><br><span class="line"><span class="built_in">substr</span></span><br><span class="line">substring</span><br><span class="line"><span class="built_in">sum</span></span><br><span class="line"><span class="built_in">tan</span></span><br><span class="line">to_date</span><br><span class="line">to_unix_timestamp</span><br><span class="line">to_utc_timestamp</span><br><span class="line"><span class="keyword">translate</span></span><br><span class="line"><span class="built_in">trim</span></span><br><span class="line"><span class="built_in">trunc</span></span><br><span class="line">ucase</span><br><span class="line">unbase64</span><br><span class="line">unhex</span><br><span class="line">unix_timestamp</span><br><span class="line"><span class="built_in">upper</span></span><br><span class="line">var_pop</span><br><span class="line">var_samp</span><br><span class="line">variance</span><br><span class="line">weekofyear</span><br><span class="line">when</span><br><span class="line">windowingtablefunction</span><br><span class="line">xpath</span><br><span class="line">xpath_boolean</span><br><span class="line">xpath_double</span><br><span class="line">xpath_float</span><br><span class="line">xpath_int</span><br><span class="line">xpath_long</span><br><span class="line">xpath_number</span><br><span class="line">xpath_short</span><br><span class="line">xpath_string</span><br><span class="line"><span class="built_in">year</span></span><br><span class="line">|</span><br><span class="line">~</span><br><span class="line">Time taken: 0.009 seconds, Fetched: 216 row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看函数具体用法：</p>
  <figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; describe function weekofyear;</span><br><span class="line">OK</span><br><span class="line">weekofyear(<span class="built_in">date</span>) - Returns <span class="keyword">the</span> week <span class="keyword">of</span> <span class="keyword">the</span> <span class="built_in">year</span> <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">given</span> <span class="built_in">date</span>. A week <span class="keyword">is</span> considered <span class="keyword">to</span> start <span class="keyword">on</span> a Monday <span class="keyword">and</span> week <span class="number">1</span> <span class="keyword">is</span> <span class="keyword">the</span> <span class="keyword">first</span> week <span class="keyword">with</span> &gt;<span class="number">3</span> days.</span><br><span class="line">Time taken: <span class="number">0.011</span> seconds, Fetched: <span class="number">1</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考<a href="https://github.com/jiaoqiyuan/163-bigdate-note/blob/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/hive%E5%87%BD%E6%95%B0%E5%A4%A7%E5%85%A8.pdf" target="_blank" rel="noopener">Hive学习大全</a>)或<a href="https://github.com/jiaoqiyuan/163-bigdate-note/blob/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/Hive%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99.md" target="_blank" rel="noopener">Hive学习资料</a>内容</p>
</li>
</ul>
<h1 id="使用聚合函数"><a href="#使用聚合函数" class="headerlink" title="使用聚合函数"></a>使用聚合函数</h1><h2 id="Hive函数分类-1"><a href="#Hive函数分类-1" class="headerlink" title="Hive函数分类"></a>Hive函数分类</h2><ul>
<li><p>内置函数：hive自带的函数</p>
<ul>
<li><p>简单函数：一进一出，用于格式化、数据运算等</p>
</li>
<li><p><strong>聚合函数</strong>：多进一出，用于统计计算、指标聚合等</p>
</li>
<li><p>集合函数：array、map操作</p>
</li>
<li><p>特殊函数：窗口函数等</p>
</li>
</ul>
</li>
<li><p>自定义函数</p>
</li>
</ul>
<h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><ul>
<li><p>商品详情页被访问了多少次？</p>
<p>  这里不关心是哪些用户(user_id)在什么时间(timt_tag)访问了什么内容(req_url)，这里比较关心的是有多少用户访问了a商品，有多少用户访问了b商品。</p>
<p>  明细数据包含的内容比较全面和细致，有时候我们不需要所有的信息，而是需要在详细信息的基础上抽象统计出一些信息，也就是汇总级别的统计数据，这就需要借助聚合函数来完成。</p>
<p>  使用sql来统计商品详情页面被访问了多少次：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    req_url,</span><br><span class="line">    <span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    bigdata.weblog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    active_name=<span class="string">'pageview'</span></span><br><span class="line">    <span class="keyword">and</span></span><br><span class="line">    req_url <span class="keyword">like</span> <span class="string">'%/product/%'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    req_url</span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>  Hive执行结果：</p>
  <figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;     <span class="keyword">select</span></span><br><span class="line">    &gt;         req_url,</span><br><span class="line">    &gt;         count(<span class="number">1</span>)</span><br><span class="line">    &gt;     from </span><br><span class="line">    &gt;         bigdata.weblog</span><br><span class="line">    &gt;     <span class="keyword">where</span></span><br><span class="line">    &gt;         active_name=<span class="string">'pageview'</span></span><br><span class="line">    &gt;         <span class="literal">and</span></span><br><span class="line">    &gt;         req_url like <span class="string">'%/product/%'</span></span><br><span class="line">    &gt;     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    &gt;         req_url</span><br><span class="line">    &gt;     limit <span class="number">10</span>;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190108134436_e79d8a13<span class="number">-03</span>f7<span class="number">-4</span>c63<span class="number">-9018</span><span class="params">-e90ae7b5ff44</span></span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Launching Job <span class="number">1</span> out of <span class="number">1</span></span><br><span class="line">Number of reduce tasks <span class="literal">not</span> specified. Estimated from input <span class="built_in">data</span> size: <span class="number">7</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the <span class="keyword">average</span> load for a reducer (<span class="keyword">in</span> <span class="built_in">bytes</span>):</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.<span class="built_in">bytes</span>.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number of reducers:</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.<span class="keyword">max</span>=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="built_in">set</span> a constant number of reducers:</span><br><span class="line">  <span class="built_in">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21652, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21652/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop<span class="params">-current</span>/bin/hadoop job  <span class="params">-kill</span> job_1535253853575_21652</span><br><span class="line">Hadoop job information for Stage<span class="number">-1</span>: number of mappers: <span class="number">6</span>; number of reducers: <span class="number">7</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">42</span>,<span class="number">854</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">51</span>,<span class="number">233</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">17</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">6.4</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">53</span>,<span class="number">292</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">18</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">27.05</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">54</span>,<span class="number">324</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">20</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">58.09</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">56</span>,<span class="number">402</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">31</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">67.98</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">57</span>,<span class="number">442</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">36</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">74.22</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">44</span>:<span class="number">59</span>,<span class="number">514</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">48</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">87.63</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">01</span>,<span class="number">688</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">59</span>%,  reduce = <span class="number">2</span>%, Cumulative CPU <span class="number">94.16</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">02</span>,<span class="number">716</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">70</span>%,  reduce = <span class="number">6</span>%, Cumulative CPU <span class="number">106.81</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">03</span>,<span class="number">742</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">90</span>%,  reduce = <span class="number">6</span>%, Cumulative CPU <span class="number">108.65</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">04</span>,<span class="number">771</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">14</span>%, Cumulative CPU <span class="number">111.35</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">05</span>,<span class="number">798</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">44</span>%, Cumulative CPU <span class="number">116.75</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-08</span> <span class="number">13</span>:<span class="number">45</span>:<span class="number">06</span>,<span class="number">867</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">128.85</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">2</span> minutes <span class="number">8</span> seconds <span class="number">850</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21652</span><br><span class="line">MapReduce Jobs Launched: </span><br><span class="line">Stage<span class="params">-Stage</span><span class="number">-1</span>: <span class="built_in">Map</span>: <span class="number">6</span>  Reduce: <span class="number">7</span>   Cumulative CPU: <span class="number">128.85</span> sec   HDFS Read: <span class="number">1571454468</span> HDFS Write: <span class="number">3828</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">2</span> minutes <span class="number">8</span> seconds <span class="number">850</span> msec</span><br><span class="line">OK</span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438746948	6582</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438747116	6646</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438747270	6510</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438748068	6562</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438748572	6495</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438748621	6535</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438748929	6482</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438750182	6545</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438751036	6489</span></span><br><span class="line">http:<span class="comment">//www.bigdataclass.com/product/1527235438751281	6564</span></span><br><span class="line">Time taken: <span class="number">31.223</span> seconds, Fetched: <span class="number">10</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>男女用户谁更会花钱？</p>
<p>  统计男女用户哪一类人群下单金额更多，sql语句如下：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    gender,</span><br><span class="line">    <span class="keyword">count</span>(t1.user_id) <span class="keyword">as</span> count_order,</span><br><span class="line">    <span class="keyword">sum</span>(pay_amount) <span class="keyword">as</span> sum_amount,</span><br><span class="line">    <span class="keyword">avg</span>(pay_amount) <span class="keyword">as</span> avg_amount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, pay_amount <span class="keyword">from</span> bigdata.orders) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, gender <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    gender</span><br></pre></td></tr></table></figure>
<p>  建立订单表：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> <span class="string">`bigdata.orders`</span> (</span><br><span class="line">    <span class="string">`order_id`</span>  <span class="keyword">string</span>  <span class="keyword">comment</span> <span class="string">'订单id'</span>,</span><br><span class="line">    <span class="string">`user_id`</span>   <span class="keyword">string</span>  <span class="keyword">comment</span> <span class="string">'用户id'</span>,</span><br><span class="line">    <span class="string">`product_id`</span>    <span class="keyword">string</span>  <span class="keyword">comment</span> <span class="string">'商品id'</span>,</span><br><span class="line">    <span class="string">`order_time`</span>  <span class="built_in">bigint</span>  <span class="keyword">comment</span> <span class="string">'下单时间'</span>,</span><br><span class="line">    <span class="string">`pay_amount`</span>    <span class="keyword">double</span>  <span class="keyword">comment</span> <span class="string">'金额'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> SERDE</span><br><span class="line">    <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">LOCATION</span><br><span class="line">    <span class="string">'/user/hadoop/hive/orders'</span></span><br></pre></td></tr></table></figure>
<p>  创建结果：</p>
  <figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; create external table <span class="string">`bigdata.orders`</span> (</span><br><span class="line">    &gt;     <span class="string">`order_id`</span>  <span class="built_in">string</span>  comment <span class="string">'订单id'</span>,</span><br><span class="line">    &gt;     <span class="string">`user_id`</span>   <span class="built_in">string</span>  comment <span class="string">'用户id'</span>,</span><br><span class="line">    &gt;     <span class="string">`product_id`</span>    <span class="built_in">string</span>  comment <span class="string">'商品id'</span>,</span><br><span class="line">    &gt;     <span class="string">`order_time`</span>  bigint  comment <span class="string">'下单时间'</span>,</span><br><span class="line">    &gt;     <span class="string">`pay_amount`</span>    <span class="built_in">double</span>  comment <span class="string">'金额'</span></span><br><span class="line">    &gt; )</span><br><span class="line">    &gt; row format SERDE</span><br><span class="line">    &gt;     <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line">    &gt; STORED AS INPUTFORMAT</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">    &gt; OUTPUTFORMAT</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">    &gt; LOCATION</span><br><span class="line">    &gt;     <span class="string">'/user/hadoop/hive/orders'</span>;</span><br><span class="line">OK</span><br><span class="line">Time <span class="attribute">taken</span>: <span class="number">0.076</span> seconds</span><br><span class="line"></span><br><span class="line">hive&gt; desc orders;</span><br><span class="line">OK</span><br><span class="line">order_id                <span class="built_in">string</span>                  订单id</span><br><span class="line">user_id                 <span class="built_in">string</span>                  用户id</span><br><span class="line">product_id              <span class="built_in">string</span>                  商品id</span><br><span class="line">order_time              bigint                  下单时间</span><br><span class="line">pay_amount              <span class="built_in">double</span>                  金额</span><br><span class="line">Time <span class="attribute">taken</span>: <span class="number">0.34</span> seconds, <span class="attribute">Fetched</span>: <span class="number">5</span> row(s)</span><br></pre></td></tr></table></figure>
<p>  统计男女用户哪一类人群下单金额更多执行结果：</p>
  <figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;     <span class="keyword">select</span></span><br><span class="line">    &gt;         gender,</span><br><span class="line">    &gt;         count(t1.user_id) <span class="keyword">as</span> count_order,</span><br><span class="line">    &gt;         sum(pay_amount) <span class="keyword">as</span> sum_amount,</span><br><span class="line">    &gt;         avg(pay_amount) <span class="keyword">as</span> avg_amount</span><br><span class="line">    &gt;     <span class="keyword">from</span></span><br><span class="line">    &gt;         (<span class="keyword">select</span> user_id, pay_amount <span class="keyword">from</span> bigdata.orders) t1</span><br><span class="line">    &gt;     <span class="keyword">join</span></span><br><span class="line">    &gt;         (<span class="keyword">select</span> user_id, gender <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line">    &gt;     <span class="keyword">on</span> t1.user_id=t2.user_id</span><br><span class="line">    &gt;     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    &gt;         gender;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190106193552_f6a32384-<span class="number">3</span>cdd-<span class="number">4343</span>-a22a-<span class="number">5394</span>c7a8b072</span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Execution log at: /tmp/<span class="number">1015146591</span>/<span class="number">1015146591</span>_20190106193552_f6a32384-<span class="number">3</span>cdd-<span class="number">4343</span>-a22a-<span class="number">5394</span>c7a8b072.log</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">56</span>     Starting <span class="keyword">to</span> launch local task <span class="keyword">to</span> process map <span class="keyword">join</span>;      maximum memory = <span class="number">508559360</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">58</span>     Dump the side-table <span class="keyword">for</span> tag: <span class="number">0</span> <span class="keyword">with</span> <span class="keyword">group</span> count: <span class="number">15104</span> <span class="keyword">into</span> file: file:/mnt/home/<span class="number">1015146591</span>/apps/hive-<span class="number">1.2</span>.<span class="number">2</span>/tmp/<span class="number">1015146591</span>/<span class="number">4195</span>d5ac-cd0c-<span class="number">484</span>a-ad5a-<span class="number">8</span>a74a78d0bf6/hive_2019-<span class="number">01</span>-<span class="number">06</span>_19-<span class="number">35</span>-<span class="number">52</span>_975_5737141907165469961-<span class="number">1</span>/-local-<span class="number">10004</span>/HashTable-Stage-<span class="number">2</span>/MapJoin-mapfile00--.hashtable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">58</span>     Uploaded <span class="number">1</span> File <span class="keyword">to</span>: file:/mnt/home/<span class="number">1015146591</span>/apps/hive-<span class="number">1.2</span>.<span class="number">2</span>/tmp/<span class="number">1015146591</span>/<span class="number">4195</span>d5ac-cd0c-<span class="number">484</span>a-ad5a-<span class="number">8</span>a74a78d0bf6/hive_2019-<span class="number">01</span>-<span class="number">06</span>_19-<span class="number">35</span>-<span class="number">52</span>_975_5737141907165469961-<span class="number">1</span>/-local-<span class="number">10004</span>/HashTable-Stage-<span class="number">2</span>/MapJoin-mapfile00--.hashtable (<span class="number">652905</span> bytes)</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">58</span>     <span class="keyword">End</span> <span class="keyword">of</span> local task; Time Taken: <span class="number">1.317</span> sec.</span><br><span class="line">Execution completed successfully</span><br><span class="line">MapredLocal task succeeded</span><br><span class="line">Launching Job <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">Number <span class="keyword">of</span> reduce tasks <span class="keyword">not</span> specified. Estimated <span class="keyword">from</span> input data size: <span class="number">1</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">set</span> a constant number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21374, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21374/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21374</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage-<span class="number">2</span>: number <span class="keyword">of</span> mappers: <span class="number">1</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">36</span>:<span class="number">06</span>,<span class="number">133</span> Stage-<span class="number">2</span> map = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">36</span>:<span class="number">12</span>,<span class="number">393</span> Stage-<span class="number">2</span> map = <span class="number">100</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">4.96</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">36</span>:<span class="number">18</span>,<span class="number">670</span> Stage-<span class="number">2</span> map = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">7.37</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">7</span> seconds <span class="number">370</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21374</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-<span class="number">2</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">7.37</span> sec   HDFS <span class="keyword">Read</span>: <span class="number">4829952</span> HDFS <span class="keyword">Write</span>: <span class="number">78</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">7</span> seconds <span class="number">370</span> msec</span><br><span class="line">OK</span><br><span class="line">女      <span class="number">7635</span>    <span class="number">474593.0</span>        <span class="number">62.16018336607728</span></span><br><span class="line">男      <span class="number">7469</span>    <span class="number">464502.0</span>        <span class="number">62.19065470611862</span></span><br><span class="line">Time taken: <span class="number">26.789</span> seconds, Fetched: <span class="number">2</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="利用正则表达精确提取信息"><a href="#利用正则表达精确提取信息" class="headerlink" title="利用正则表达精确提取信息"></a>利用正则表达精确提取信息</h1><h2 id="原始日志数据的局限"><a href="#原始日志数据的局限" class="headerlink" title="原始日志数据的局限"></a>原始日志数据的局限</h2><ul>
<li><p>特定业务数据，往往只针对特定业务场景埋点。</p>
</li>
<li><p>如何获取商品的访问量</p>
<p>  日志详情中只有下单后才会记录商品id，这就需要从其他表中提取出相关信息然后组合得到商品的访问量。数据匹配和提取一般使用正则表达式。</p>
</li>
</ul>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><ul>
<li><p>正则表达式描述了一种字符串匹配的模式，可以用来：</p>
<ul>
<li><p>检查一个字符串是否含有某种字串</p>
</li>
<li><p>将匹配的字串替换</p>
</li>
<li><p>从某个字符串中去除符合某个条件的字串</p>
</li>
</ul>
</li>
<li><p>Hive中对应的的正则表达式函数</p>
<ul>
<li><p>regexp: A regexp ‘[0-9]+’</p>
</li>
<li><p>regexp_replace: regexp_replace(A, ‘[0-9]+’, ‘’)</p>
</li>
<li><p>regexp_extract: regexp_extract(A, ‘([0-9]+)’, 1)</p>
</li>
</ul>
</li>
<li><p>这里有我之前写的<a href="https://jiaoqiyuan.cn/2018/03/25/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%9F%BA%E7%A1%80/" target="_blank" rel="noopener">正则表达式基础</a>，介绍了正则表达式常用的功能，可以参考一下。</p>
</li>
</ul>
<h2 id="计算商品访问量"><a href="#计算商品访问量" class="headerlink" title="计算商品访问量"></a>计算商品访问量</h2><p>用户访问的url类似下面这种：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>www.bigdataclass.com<span class="regexp">/my/</span><span class="number">4921528165744221</span></span><br></pre></td></tr></table></figure>
<p>这里面其实包含有商品id：4921528165744221，也就是可以从url中提取商品id。</p>
<p>从日志表中提取商品req_url的sql查询语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    regexp_extract(req_url, <span class="string">'.*/product/([0-9]+).*'</span>, <span class="number">1</span>) <span class="keyword">as</span> product_id,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id) <span class="keyword">as</span> count_user</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    bigdata.weblog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    active_name = <span class="string">'pageview'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    regexp_extract(req_url, <span class="string">'.*/product/([0-9]+).*'</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">sort</span> <span class="keyword">by</span></span><br><span class="line">    count_user <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;     select</span><br><span class="line">    &gt;         t1.user_id,</span><br><span class="line">    &gt;         gender,</span><br><span class="line">    &gt;         register_time</span><br><span class="line">    &gt;     from</span><br><span class="line">    &gt;     (select user_id from bigdata.weblog where active_name='order') t1</span><br><span class="line">    &gt;     join</span><br><span class="line">    &gt;     (select user_id, gender, register_time from bigdata.member) t2</span><br><span class="line">    &gt;     on t1.user_id=t2.user_id</span><br><span class="line">    &gt;     limit 10;</span><br><span class="line">Query ID = 1015146591_20190106214620_a2dc30a1-c49a<span class="string">-4</span>b4f-b6ca-c69f75f0f0a9</span><br><span class="line">Total jobs = 1</span><br><span class="line">Execution log at: /tmp/1015146591/1015146591_20190106214620_a2dc30a1-c49a<span class="string">-4</span>b4f-b6ca-c69f75f0f0a9.log</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:23     Starting to launch local task to process map join;      maximum memory = 508559                       360</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:25     Dump the side-table for tag: 1 with group count: 30179 into file: file:/mnt/hom                       e/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56db34a6-e449<span class="string">-46</span>da<span class="string">-8</span>f06<span class="string">-44</span>d209832b4b/hive_2019<span class="string">-01</span><span class="string">-06</span>_21<span class="string">-46</span>-                       20_022_498414055630965492<span class="string">-1</span>/-local<span class="string">-10003</span>/HashTable-Stage<span class="string">-3</span>/MapJoin-mapfile01--.hashtable</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:25     Uploaded 1 File to: file:/mnt/home/1015146591/apps/hive<span class="string">-1</span>.2.2/tmp/1015146591/56                       db34a6-e449<span class="string">-46</span>da<span class="string">-8</span>f06<span class="string">-44</span>d209832b4b/hive_2019<span class="string">-01</span><span class="string">-06</span>_21<span class="string">-46</span><span class="string">-20</span>_022_498414055630965492<span class="string">-1</span>/-local<span class="string">-10003</span>/HashT                       able-Stage<span class="string">-3</span>/MapJoin-mapfile01--.hashtable (1395272 bytes)</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:25     End of local task; Time Taken: 2.058 sec.</span><br><span class="line">Execution completed successfully</span><br><span class="line">MapredLocal task succeeded</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks is set to 0 since there's no reduce operator</span><br><span class="line">Starting Job = job_1535253853575_21443, Tracking URL = http://bigdata0.novalocal:8088/proxy/application                       _1535253853575_21443/</span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21443</span><br><span class="line">Hadoop job information for Stage<span class="string">-3</span>: number of mappers: 6; number of reducers: 0</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:31,848 Stage<span class="string">-3</span> map = 0%,  reduce = 0%</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:38,076 Stage<span class="string">-3</span> map = 17%,  reduce = 0%, Cumulative CPU 4.47 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:39,105 Stage<span class="string">-3</span> map = 33%,  reduce = 0%, Cumulative CPU 9.23 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:41,181 Stage<span class="string">-3</span> map = 50%,  reduce = 0%, Cumulative CPU 16.87 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:43,238 Stage<span class="string">-3</span> map = 54%,  reduce = 0%, Cumulative CPU 49.97 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:46,315 Stage<span class="string">-3</span> map = 69%,  reduce = 0%, Cumulative CPU 59.98 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:49,421 Stage<span class="string">-3</span> map = 78%,  reduce = 0%, Cumulative CPU 69.79 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:51,474 Stage<span class="string">-3</span> map = 86%,  reduce = 0%, Cumulative CPU 72.01 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:52,510 Stage<span class="string">-3</span> map = 93%,  reduce = 0%, Cumulative CPU 78.08 sec</span><br><span class="line">2019<span class="string">-01</span><span class="string">-06</span> 21:46:54,570 Stage<span class="string">-3</span> map = 100%,  reduce = 0%, Cumulative CPU 80.35 sec</span><br><span class="line">MapReduce Total cumulative CPU time: 1 minutes 20 seconds 350 msec</span><br><span class="line">Ended Job = job_1535253853575_21443</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage<span class="string">-3</span>: Map: 6   Cumulative CPU: 80.35 sec   HDFS Read: 942483911 HDFS Write: 760 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 1 minutes 20 seconds 350 msec</span><br><span class="line">OK</span><br><span class="line">8201531897436759        男      1526031234916</span><br><span class="line">2211531897362630        男      1519311748534</span><br><span class="line">8431531897389241        男      1520079723099</span><br><span class="line">3211531897369709        男      1523560308175</span><br><span class="line">6911531897308202        女      1525233502748</span><br><span class="line">5041531897225960        男      1527678449938</span><br><span class="line">7391531897436409        女      1527670790734</span><br><span class="line">8191531897363226        男      1526696249998</span><br><span class="line">0851531897431904        女      1524085244386</span><br><span class="line">7031531897150536        女      1527243924519</span><br><span class="line">Time taken: 35.608 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>
<h1 id="使用窗口函数"><a href="#使用窗口函数" class="headerlink" title="使用窗口函数"></a>使用窗口函数</h1><h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><p>如果存在多行输入，多行输出，并且要求输出的每行数据不仅包含它所在行的数据信息，还包括它所在分组内的其他行的信息，这时就需要窗口函数完成。</p>
<h2 id="下单用户路径分析"><a href="#下单用户路径分析" class="headerlink" title="下单用户路径分析"></a>下单用户路径分析</h2><p><img src="https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/img/%E4%B8%8B%E5%8D%95%E7%94%A8%E6%88%B7%E8%B7%AF%E5%BE%84.png" alt="下单路径分析"></p>
<p>有时我们不仅想知道用户当前的行为，还想知道用户当前行为前后用户的行为轨迹：</p>
<p>从哪个页面着陆？            ——&gt;   窗口内排序或偏移量</p>
<p>下单前的最后页面？          ——&gt;   窗口内偏移量</p>
<p>下单之前浏览了多少页面？     ——&gt;   窗口内聚合</p>
<h2 id="窗口函数的语法"><a href="#窗口函数的语法" class="headerlink" title="窗口函数的语法"></a>窗口函数的语法</h2><ul>
<li>语法格式：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function(arg1, ....argn) OVER ([PARTITION BY&lt;...&gt;] [ORDER BY&lt;...&gt;] [window_clause])</span><br></pre></td></tr></table></figure>
<ul>
<li><p>偏移量函数</p>
<ul>
<li><p>First_value/Last_value</p>
</li>
<li><p>Lead/Lag</p>
</li>
</ul>
</li>
<li><p>聚合函数</p>
<ul>
<li><p>COUNT/SUM</p>
</li>
<li><p>AVG/MIN/MAX</p>
</li>
</ul>
</li>
<li><p>排序函数</p>
<ul>
<li><p>ROW_NUMBER()</p>
</li>
<li><p>RNAK()</p>
</li>
<li><p>DENSE_RANK()</p>
</li>
</ul>
</li>
</ul>
<h2 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    session_id,</span><br><span class="line">    landing_page,</span><br><span class="line">    last_page,</span><br><span class="line">    count_visit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    session_id,</span><br><span class="line">    active_name,</span><br><span class="line">    <span class="keyword">first_value</span>(req_url) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag <span class="keyword">asc</span>) <span class="keyword">as</span> landing_page,</span><br><span class="line">    lag(req_url, <span class="number">1</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag <span class="keyword">asc</span>) <span class="keyword">as</span> last_page,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">if</span>(active_name = <span class="string">'pageview'</span>, req_url, <span class="literal">null</span>)) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag <span class="keyword">asc</span> <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span>) <span class="keyword">as</span> count_visit</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.weblog) t1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    active_name = <span class="string">'order'</span></span><br></pre></td></tr></table></figure>
<p>这里的count_visit中添加了row between关键字用于指定窗口范围，默认是从开始到当前行。使用partition by进行分组，count_visit表示下单前浏览了多少个页面，last_page表示下单前浏览的最后一个页面，landing_page表示该用户从哪个页面开始浏览的。</p>
<p>运行结果：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     session_id,</span><br><span class="line">    &gt;     landing_page,</span><br><span class="line">    &gt;     last_page,</span><br><span class="line">    &gt;     count_visit</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt; (<span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     session_id,</span><br><span class="line">    &gt;     active_name,</span><br><span class="line">    &gt;     first_value(req_url) over (partition <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag asc) as landing_page,</span><br><span class="line">    &gt;     lag(req_url, <span class="number">1</span>) over (partition <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag asc) as last_page,</span><br><span class="line">    &gt;     count(<span class="keyword">if</span>(active_name = <span class="string">'pageview'</span>, req_url, <span class="built_in">null</span>)) over (partition <span class="keyword">by</span> session_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag asc <span class="keyword">rows</span> between unbounded preceding <span class="literal">and</span> current row) as count_visit</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt;     bigdata.weblog) t1</span><br><span class="line">    &gt; <span class="keyword">where</span></span><br><span class="line">    &gt;     active_name = <span class="string">'order'</span></span><br><span class="line">    &gt; limit <span class="number">5</span>;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190106223135_9fbad1ed<span class="number">-4</span>f61<span class="number">-41</span>f0<span class="params">-bbe3</span><span class="params">-a64ea54c3234</span></span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Launching Job <span class="number">1</span> out of <span class="number">1</span></span><br><span class="line">Number of reduce tasks <span class="literal">not</span> specified. Estimated from input <span class="built_in">data</span> size: <span class="number">7</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the <span class="keyword">average</span> load for a reducer (<span class="keyword">in</span> <span class="built_in">bytes</span>):</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.<span class="built_in">bytes</span>.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number of reducers:</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.<span class="keyword">max</span>=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="built_in">set</span> a constant number of reducers:</span><br><span class="line">  <span class="built_in">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21468, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21468/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop<span class="params">-current</span>/bin/hadoop job  <span class="params">-kill</span> job_1535253853575_21468</span><br><span class="line">Hadoop job information for Stage<span class="number">-1</span>: number of mappers: <span class="number">6</span>; number of reducers: <span class="number">7</span></span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">40</span>,<span class="number">964</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">49</span>,<span class="number">289</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">17</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">4.94</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">51</span>,<span class="number">411</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">18</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">14.03</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">52</span>,<span class="number">442</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">20</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">49.51</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">54</span>,<span class="number">511</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">31</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">59.51</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">55</span>,<span class="number">606</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">40</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">66.21</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">57</span>,<span class="number">678</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">48</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">79.31</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">59</span>,<span class="number">728</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">48</span>%,  reduce = <span class="number">2</span>%, Cumulative CPU <span class="number">83.35</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">00</span>,<span class="number">808</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">64</span>%,  reduce = <span class="number">5</span>%, Cumulative CPU <span class="number">100.0</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">01</span>,<span class="number">833</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">70</span>%,  reduce = <span class="number">6</span>%, Cumulative CPU <span class="number">101.13</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">02</span>,<span class="number">857</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">80</span>%,  reduce = <span class="number">10</span>%, Cumulative CPU <span class="number">103.94</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">03</span>,<span class="number">882</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">16</span>%, Cumulative CPU <span class="number">111.57</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">04</span>,<span class="number">907</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">19</span>%, Cumulative CPU <span class="number">111.83</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">05</span>,<span class="number">962</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">39</span>%, Cumulative CPU <span class="number">115.43</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">06</span>,<span class="number">998</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">74</span>%, Cumulative CPU <span class="number">134.61</span> sec</span><br><span class="line"><span class="number">2019</span><span class="number">-01</span><span class="number">-06</span> <span class="number">22</span>:<span class="number">32</span>:<span class="number">08</span>,<span class="number">022</span> Stage<span class="number">-1</span> <span class="built_in">map</span> = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">151.51</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">2</span> minutes <span class="number">31</span> seconds <span class="number">510</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21468</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage<span class="params">-Stage</span><span class="number">-1</span>: <span class="built_in">Map</span>: <span class="number">6</span>  Reduce: <span class="number">7</span>   Cumulative CPU: <span class="number">151.51</span> sec   HDFS Read: <span class="number">1571477509</span> HDFS Write: <span class="number">5090</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">2</span> minutes <span class="number">31</span> seconds <span class="number">510</span> msec</span><br><span class="line">OK</span><br><span class="line"><span class="number">9671531898173445</span>        <span class="number">00022</span>b2a858240b29d61daf4e2fa4e0f        http:<span class="comment">//www.bigdataclass.com/my/9671531898173445 http://www.bigdataclass.com/product/1527235438750267  11</span></span><br><span class="line"><span class="number">5161531907295812</span>        <span class="number">000</span>dbaa1bff541719a5a49cbe014ce98        http:<span class="comment">//www.bigdataclass.com     http://www.bigdataclass.com/product/1527235438751118  16</span></span><br><span class="line"><span class="number">4341531901218931</span>        <span class="number">00269566</span>c4a74e348392bf2c203afb19        http:<span class="comment">//www.bigdataclass.com/my/4341531901218931 http://www.bigdataclass.com/product/1527235438749603  9</span></span><br><span class="line"><span class="number">8471531908135174</span>        <span class="number">00277e11</span>aec54eae8a3791a0d20b4aa0        http:<span class="comment">//www.bigdataclass.com/category    http://www.bigdataclass.com/product/1527235438751276  12</span></span><br><span class="line"><span class="number">2301531907877448</span>        <span class="number">002</span>c4ca8e141433693187759f1f774f2        http:<span class="comment">//www.bigdataclass.com     http://www.bigdataclass.com/product/1527235438749743  11</span></span><br><span class="line">Time taken: <span class="number">33.993</span> seconds, Fetched: <span class="number">5</span> row(s)</span><br></pre></td></tr></table></figure>
<h1 id="行转列与列转行"><a href="#行转列与列转行" class="headerlink" title="行转列与列转行"></a>行转列与列转行</h1><h2 id="行转列业务场景"><a href="#行转列业务场景" class="headerlink" title="行转列业务场景"></a>行转列业务场景</h2><p>业务场景：用户分析</p>
<p>要做用户分析，但是原始数据中及记录的是每条日志详情，内容如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">用户id</th>
<th style="text-align:center">购买商品id</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1</td>
</tr>
<tr>
<td style="text-align:center">…..</td>
<td style="text-align:center">…..</td>
</tr>
</tbody>
</table>
<p>这个粒度太细，不便于我们分析，我们其实想得到的可能是用户维度的数据，类似下面这种：</p>
<table>
<thead>
<tr>
<th style="text-align:center">用户id</th>
<th style="text-align:center">购买商品id</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">001</td>
<td style="text-align:center">Product1, Product2, product3</td>
</tr>
<tr>
<td style="text-align:center">002</td>
<td style="text-align:center">Product1, Product2, product3</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
</tbody>
</table>
<p>也就是把它聚合成每个用户为一行，把一个用户购买的所有商品都聚合到一个字段中，这其实就是行转列的操作。</p>
<h2 id="Hive中行转列函数"><a href="#Hive中行转列函数" class="headerlink" title="Hive中行转列函数"></a>Hive中行转列函数</h2><blockquote>
<p>collect_set()： 不插入重复记录</p>
</blockquote>
<blockquote>
<p>collect_list(): 保留重复记录</p>
</blockquote>
<p>SQL测试语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    collect_set(product_id),</span><br><span class="line">    collect_list(product_id)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.orders</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    user_id</span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select</span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     collect_set(product_id),</span><br><span class="line">    &gt;     collect_list(product_id)</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt;     bigdata.orders</span><br><span class="line">    &gt; group by</span><br><span class="line">    &gt;     user_id</span><br><span class="line">    &gt; <span class="built_in">limit</span> 10;</span><br><span class="line">Query ID = 1015146591_20190107204725_cc30fd60-41fa-4137-b3cf-3cb5889586d8</span><br><span class="line">Total <span class="built_in">jobs</span> = 1</span><br><span class="line">Launching Job 1 out of 1</span><br><span class="line">Number of reduce tasks not specified. Estimated from input data size: 1</span><br><span class="line">In order to change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line">In order to <span class="built_in">limit</span> the maximum number of reducers:</span><br><span class="line">  <span class="built_in">set</span> hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line">In order to <span class="built_in">set</span> a constant number of reducers:</span><br><span class="line">  <span class="built_in">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21559, Tracking URL = http://bigdata0.novalocal:8088/proxy/application_1535253853575_21559/</span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -<span class="built_in">kill</span> job_1535253853575_21559</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage-1: number of mappers: 1; number of reducers: 1</span><br><span class="line">2019-01-07 20:47:34,327 Stage-1 map = 0%,  reduce = 0%</span><br><span class="line">2019-01-07 20:47:40,615 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 3.71 sec</span><br><span class="line">2019-01-07 20:47:45,798 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 6.32 sec</span><br><span class="line">MapReduce Total cumulative CPU time: 6 seconds 320 msec</span><br><span class="line">Ended Job = job_1535253853575_21559</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-1: Map: 1  Reduce: 1   Cumulative CPU: 6.32 sec   HDFS Read: 2064643 HDFS Write: 510 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 6 seconds 320 msec</span><br><span class="line">OK</span><br><span class="line">0001528166031761        [<span class="string">"1527235438747744"</span>]    [<span class="string">"1527235438747744"</span>]</span><br><span class="line">0001531897281376        [<span class="string">"1527235438746891"</span>]    [<span class="string">"1527235438746891"</span>]</span><br><span class="line">0001531897292909        [<span class="string">"1527235438750711"</span>]    [<span class="string">"1527235438750711"</span>]</span><br><span class="line">0001531897299559        [<span class="string">"1527235438750618"</span>]    [<span class="string">"1527235438750618"</span>]</span><br><span class="line">0001531897444689        [<span class="string">"1527235438750087"</span>]    [<span class="string">"1527235438750087"</span>]</span><br><span class="line">0001531898180216        [<span class="string">"1527235438750087"</span>]    [<span class="string">"1527235438750087"</span>]</span><br><span class="line">0001531898269760        [<span class="string">"1527235438747610"</span>]    [<span class="string">"1527235438747610"</span>]</span><br><span class="line">0001531898480773        [<span class="string">"1527235438748507"</span>]    [<span class="string">"1527235438748507"</span>]</span><br><span class="line">0011528165930044        [<span class="string">"1527235438748829"</span>]    [<span class="string">"1527235438748829"</span>]</span><br><span class="line">0011528165983913        [<span class="string">"1527235438746782"</span>]    [<span class="string">"1527235438746782"</span>]</span><br><span class="line">Time taken: 21.048 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></table></figure>
<p>使用这两个行专列的函数类似于下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">用户id</th>
<th style="text-align:center">购买商品id(collect_set)</th>
<th style="text-align:center">购买商品id(collect_list)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0001</td>
<td style="text-align:center">product1, product2</td>
<td style="text-align:center">product1, product2, product2</td>
</tr>
<tr>
<td style="text-align:center">0002</td>
<td style="text-align:center">product1, product2, product3</td>
<td style="text-align:center">product1, product2, product3</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
</tbody>
</table>
<p>collect_set和collect_list就是聚合函数的一种，这里单独列出来讲是因为在实际业务中经常使用行转列和列转行这两种方法。</p>
<h2 id="用户画像"><a href="#用户画像" class="headerlink" title="用户画像"></a>用户画像</h2><p>用户画像是指根据用户的社会属性、生活习惯、消费行为等等各种信息抽象出来的一个标签化的用户模型，用户画像的作用是让用户的运营更加精细化，根据用户特点去做不同的运营措施。</p>
<p><img src="https://sdkfiledl.jiguang.cn/public/1a169f28d3cd4c1ab2927b18226052e7.gif" alt="用户画像"></p>
<p>用户画像的核心就是对用户打标签，比如可以从业务数据中整理出下列用户信息：</p>
<ul>
<li><p>性别</p>
</li>
<li><p>年龄</p>
</li>
<li><p>设备类型</p>
</li>
<li><p>注册时间</p>
</li>
<li><p>首次下单时间</p>
</li>
<li><p>最近一次下单时间</p>
</li>
<li><p>下单次数</p>
</li>
<li><p>下单金额</p>
</li>
<li><p>最近一次下单地理位置</p>
</li>
<li><p>…</p>
</li>
</ul>
<p>根据这一系列数据就可以建立起一个庞大的用户画像标签库，基于这个标签库可以分析用户相关的各种行为，从而针对不同的用户指定不同的运营策略。</p>
<p>现在有一个问题：建立这些标签的数据往往是分布在不同的日志数据源中的，应该通过怎样的一种方式来建立用户画像标签库呢？</p>
<h3 id="计算N个指标的实现方式一"><a href="#计算N个指标的实现方式一" class="headerlink" title="计算N个指标的实现方式一"></a>计算N个指标的实现方式一</h3><p>通过一个个子语句从不同的数据表中加工出需要的数据指标，然后通过庞大的sql把这些指标串联起来，这是最直接的方式，往往也是最麻烦的方式。</p>
<p>sql语句大概是这个样子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    gender,</span><br><span class="line">    age,</span><br><span class="line">    device_type,</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> ... <span class="keyword">from</span> ...) t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> ... <span class="keyword">from</span> ...) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> ... <span class="keyword">from</span> ...) t3</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>这种方法的优点：直观</p>
<p>缺点：</p>
<ul>
<li><p>代码冗长</p>
</li>
<li><p>字段输出顺序固定，可维护性弱</p>
</li>
<li><p>运行效率低下：所有指标都集中在一个sql语句中，不能并行执行，导致效率低下。</p>
</li>
</ul>
<h3 id="计算N个指标的实现方式二"><a href="#计算N个指标的实现方式二" class="headerlink" title="计算N个指标的实现方式二"></a>计算N个指标的实现方式二</h3><p>使用行转列或列转行的方式来完成用户标签库的建立，把一步实现的方式分多步完成，一般步骤如下：</p>
<ul>
<li><p>建立key-value中间表</p>
</li>
<li><p>分组计算各字段，列转行存入中间表</p>
</li>
<li><p>中间表行转列为大宽表</p>
</li>
</ul>
<ol>
<li><p>先建一个中间表和一个大宽表：</p>
<p> 中间表：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> <span class="string">`bigdata.user_tag_value`</span> (</span><br><span class="line">    <span class="string">`user_id`</span>   <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'用户组'</span>,</span><br><span class="line">    <span class="string">`tag`</span>       <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'标签'</span>,</span><br><span class="line">    <span class="string">`value`</span>     <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'标签值'</span>)</span><br><span class="line">partitioned <span class="keyword">by</span> (</span><br><span class="line">    <span class="string">`module`</span>    <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'标签模块'</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE</span><br><span class="line">    <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">    <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">location</span><br><span class="line">    <span class="string">'/user/1015146591/hive/user_profile/tag_value'</span></span><br></pre></td></tr></table></figure>
<p> 大宽表：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> <span class="string">`bigdata.user_profile`</span> (</span><br><span class="line">    <span class="string">`user_id`</span>   <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'用户id'</span>,</span><br><span class="line">    <span class="string">`profile`</span>   <span class="keyword">string</span>      <span class="keyword">comment</span>     <span class="string">'用户标签'</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> serde</span><br><span class="line">    <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> inputformat</span><br><span class="line">    <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">outputformat</span><br><span class="line">    <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">location</span><br><span class="line">    <span class="string">'/user/1015146591/hive/user_profile/user_profile'</span></span><br></pre></td></tr></table></figure>
<p> 分别执行：</p>
 <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;</span><br><span class="line">    &gt;</span><br><span class="line">    &gt; create external table `bigdata.user_tag_value` (</span><br><span class="line">    &gt;     `user_id`   string      comment     <span class="string">'用户组'</span>,</span><br><span class="line">    &gt;     `tag`       string      comment     <span class="string">'标签'</span>,</span><br><span class="line">    &gt;     `value`     string      comment     <span class="string">'标签值'</span>)</span><br><span class="line">    &gt; partitioned by (</span><br><span class="line">    &gt;     `<span class="keyword">module</span>`    string      comment     <span class="string">'标签模块'</span>)</span><br><span class="line">    &gt; ROW FORMAT SERDE</span><br><span class="line">    &gt;     <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line">    &gt; STORED AS INPUTFORMAT</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">    &gt; OUTPUTFORMAT</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">    &gt; location</span><br><span class="line">    &gt;     <span class="string">'/user/1015146591/hive/user_profile/tag_value'</span>;</span><br><span class="line">OK</span><br><span class="line">Time taken: <span class="number">0.195</span> seconds</span><br><span class="line">hive&gt; create external table `bigdata.user_profile` (</span><br><span class="line">    &gt;     `user_id`   string      comment     <span class="string">'用户id'</span>,</span><br><span class="line">    &gt;     `profile`   string      comment     <span class="string">'用户标签'</span>)</span><br><span class="line">    &gt; row format serde</span><br><span class="line">    &gt;     <span class="string">'org.openx.data.jsonserde.JsonSerDe'</span></span><br><span class="line">    &gt; stored <span class="keyword">as</span> inputformat</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span></span><br><span class="line">    &gt; outputformat</span><br><span class="line">    &gt;     <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></span><br><span class="line">    &gt; location</span><br><span class="line">    &gt;     <span class="string">'/user/1015146591/hive/user_profile/user_profile'</span>;</span><br><span class="line">OK</span><br><span class="line">Time taken: <span class="number">0.041</span> seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后计算各个字段，存入中间表，先分组group1，将用户的性别、年龄、设备类型、注册日期提取出来存放到中间表中：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> bigdata.user_tag_value <span class="keyword">partition</span>(<span class="keyword">module</span>=<span class="string">'basic_info'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    mp[<span class="string">'key'</span>],</span><br><span class="line">    mp[<span class="string">'value'</span>]</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">array</span>(</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'gender'</span>, <span class="string">'value'</span>, gender),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'age'</span>, <span class="string">'value'</span>, <span class="keyword">cast</span>(<span class="number">2018</span>-from_unixtime(<span class="keyword">cast</span>(birthday/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>), <span class="string">'yyyy'</span>) <span class="keyword">as</span> <span class="keyword">string</span>)),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'device_type'</span>, <span class="string">'value'</span>, device_type),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'register_day'</span>, <span class="string">'value'</span>, from_unixtime(<span class="keyword">cast</span>(register_time/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>), <span class="string">'yyyy-MM-dd'</span>))</span><br><span class="line">        ) <span class="keyword">as</span> arr</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        bigdata.member</span><br><span class="line">    ) s lateral <span class="keyword">view</span> explode(arr) arrtable <span class="keyword">as</span> mp</span><br></pre></td></tr></table></figure>
<p> 执行结果：</p>
 <figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; insert overwrite table bigdata.user_tag_value partition(module='basic_info')</span><br><span class="line">    &gt; select</span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     mp['key'],</span><br><span class="line">    &gt;     mp['value']</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt; (select</span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     array(map('key', 'gender', 'value', gender),</span><br><span class="line">    &gt;     map('key', 'age', 'value', cast(<span class="number">2018</span>-from_unixtime(cast(birthday/<span class="number">1000</span> as bigint)                                                                                                                                                , 'yyyy') as string)),</span><br><span class="line">    &gt;     map('key', 'device_type', 'value', device_type),</span><br><span class="line">    &gt;     map('key', 'register_day', 'value', from_unixtime(cast(register_time/<span class="number">1000</span> as big                                                                                                                                                int), 'yyyy-MM-dd'))</span><br><span class="line">    &gt;     ) as arr</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt;     bigdata.member) s lateral view explode(arr) arrtable as mp;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190107223740_dc7872a5-d395-<span class="number">4673</span>-<span class="number">815</span>d-<span class="number">1</span>db820668c96</span><br><span class="line">Total jobs = <span class="number">3</span></span><br><span class="line">Launching Job <span class="number">1</span> out of <span class="number">3</span></span><br><span class="line">Number of reduce tasks is set to <span class="number">0</span> since there's no reduce operator</span><br><span class="line">Starting Job = job_<span class="number">153525385357</span>5_<span class="number">2157</span>2, Tracking URL = http://bigdata0.novalocal:<span class="number">8088</span>/prox                                                                                                                                                y/application_<span class="number">153525385357</span>5_<span class="number">2157</span>2/</span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_<span class="number">153525385357</span>5_<span class="number">2157</span>2</span><br><span class="line">Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 0</span><br><span class="line"><span class="number">2019-01-07</span> 22:37:46,508 Stage-1 map = 0%,  reduce = 0%</span><br><span class="line"><span class="number">2019-01-07</span> 22:37:53,799 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 7.17 sec</span><br><span class="line">MapReduce Total cumulative CPU time: 7 seconds 170 msec</span><br><span class="line">Ended Job = job_<span class="number">153525385357</span>5_<span class="number">2157</span>2</span><br><span class="line">Stage-4 is selected by condition resolver.</span><br><span class="line">Stage-3 is filtered out by condition resolver.</span><br><span class="line">Stage-5 is filtered out by condition resolver.</span><br><span class="line">Moving data to: hdfs://bigdata0:<span class="number">5000</span>0/user/<span class="number">1015146591</span>/hive/user_profile/tag_value/module=basic_info/.hive-staging_hive_<span class="number">2019-01-07</span>_22-37-40_449_<span class="number">20870259535139</span><span class="number">0267</span>6-1/-ext-<span class="number">1000</span>0</span><br><span class="line">Loading data to table bigdata.user_tag_value partition (module=basic_info)</span><br><span class="line">Partition bigdata.user_tag_value&#123;module=basic_info&#125; stats: [numFiles=1, numRows=<span class="number">120716</span>, totalSize=<span class="number">779623</span>1, rawDataSize=0]</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-1: Map: 1   Cumulative CPU: 7.17 sec   HDFS Read: <span class="number">482250</span>7 HDFS Write: <span class="number">779633</span>1 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 7 seconds 170 msec</span><br><span class="line">OK</span><br><span class="line">Time taken: 14.745 seconds</span><br></pre></td></tr></table></figure>
<p> 查看一下执行后中间表内的数据：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> bigdata.user_tag_value <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
 <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">hive</span>&gt; <span class="keyword">select </span>* from <span class="keyword">bigdata.user_tag_value </span>limit <span class="number">10</span><span class="comment">;</span></span><br><span class="line"><span class="symbol">OK</span></span><br><span class="line"><span class="number">0001528166058390</span>        gender  女      <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001528166058390 </span>       age     <span class="number">26</span>.<span class="number">0</span>    <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001528166058390 </span>       device_type     WEB     <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001528166058390 </span>       register_day    <span class="number">2018</span>-<span class="number">04</span>-<span class="number">09</span>      <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897045258 </span>       gender  男      <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897045258 </span>       age     <span class="number">34</span>.<span class="number">0</span>    <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897045258 </span>       device_type     IPhone  <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897045258 </span>       register_day    <span class="number">2018</span>-<span class="number">03</span>-<span class="number">26</span>      <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897084097 </span>       gender  女      <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">0001531897084097 </span>       age     <span class="number">39</span>.<span class="number">0</span>    <span class="keyword">basic_info</span></span><br><span class="line"><span class="keyword">Time </span>taken: <span class="number">0</span>.<span class="number">101</span> seconds, Fetched: <span class="number">10</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>提取首次下单时间、最近下单时间、下单次数、下单金额</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> bigdata.user_tag_value <span class="keyword">partition</span>(<span class="keyword">module</span>=<span class="string">'consume_info'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    mp[<span class="string">'key'</span>],</span><br><span class="line">    mp[<span class="string">'value'</span>]</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">array</span>(</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'first_order_time'</span>, <span class="string">'value'</span>, <span class="keyword">min</span>(order_time)),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'last_order_time'</span>, <span class="string">'value'</span>, <span class="keyword">max</span>(order_time)),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'order_count'</span>, <span class="string">'value'</span>, <span class="keyword">count</span>(<span class="number">1</span>)),</span><br><span class="line">        <span class="keyword">map</span>(<span class="string">'key'</span>, <span class="string">'order_sum'</span>, <span class="string">'value'</span>, <span class="keyword">sum</span>(pay_amount))</span><br><span class="line">        ) <span class="keyword">as</span> arr</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        bigdata.orders</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        user_id</span><br><span class="line">    ) s lateral <span class="keyword">view</span> explode(arr) arrtable <span class="keyword">as</span> mp</span><br></pre></td></tr></table></figure>
<p> 执行结果：</p>
 <figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; insert overwrite table bigdata.user_tag_value partition(<span class="keyword">module</span>=<span class="string">'consume_info'</span>)</span><br><span class="line">    &gt; <span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     mp[<span class="string">'key'</span>],</span><br><span class="line">    &gt;     mp[<span class="string">'value'</span>]</span><br><span class="line">    &gt; <span class="keyword">from</span></span><br><span class="line">    &gt;     (<span class="keyword">select</span></span><br><span class="line">    &gt;         user_id,</span><br><span class="line">    &gt;         <span class="keyword">array</span>(</span><br><span class="line">    &gt;         map(<span class="string">'key'</span>, <span class="string">'first_order_time'</span>, <span class="string">'value'</span>, min(order_time)),</span><br><span class="line">    &gt;         map(<span class="string">'key'</span>, <span class="string">'last_order_time'</span>, <span class="string">'value'</span>, max(order_time)),</span><br><span class="line">    &gt;         map(<span class="string">'key'</span>, <span class="string">'order_count'</span>, <span class="string">'value'</span>, count(<span class="number">1</span>)),</span><br><span class="line">    &gt;         map(<span class="string">'key'</span>, <span class="string">'order_sum'</span>, <span class="string">'value'</span>, sum(pay_amount))</span><br><span class="line">    &gt;         ) <span class="keyword">as</span> arr</span><br><span class="line">    &gt;     <span class="keyword">from</span></span><br><span class="line">    &gt;         bigdata.orders</span><br><span class="line">    &gt;     <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    &gt;         user_id</span><br><span class="line">    &gt;     ) s lateral view explode(arr) arrtable <span class="keyword">as</span> mp;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190107225440_13303ef4-cfc3-<span class="number">4</span>eae-bb89-<span class="number">42</span>f04e10689e</span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Launching Job <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">Number <span class="keyword">of</span> reduce tasks <span class="keyword">not</span> specified. Estimated <span class="keyword">from</span> input data size: <span class="number">1</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">set</span> a constant number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21573, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21573/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21573</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage-<span class="number">1</span>: number <span class="keyword">of</span> mappers: <span class="number">1</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">22</span>:<span class="number">54</span>:<span class="number">47</span>,<span class="number">927</span> Stage-<span class="number">1</span> map = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">22</span>:<span class="number">54</span>:<span class="number">53</span>,<span class="number">307</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">3.77</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">22</span>:<span class="number">54</span>:<span class="number">59</span>,<span class="number">521</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">9.63</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">9</span> seconds <span class="number">630</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21573</span><br><span class="line">Loading data <span class="keyword">to</span> table bigdata.user_tag_value partition (<span class="keyword">module</span>=consume_info)</span><br><span class="line">Partition bigdata.user_tag_value<span class="comment">&#123;module=consume_info&#125;</span> stats: [numFiles=<span class="number">1</span>, numRows=<span class="number">60416</span>, totalSize=<span class="number">4321419</span>, rawDataSize=<span class="number">0</span>]</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-<span class="number">1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">9.63</span> sec   HDFS <span class="keyword">Read</span>: <span class="number">2068108</span> HDFS <span class="keyword">Write</span>: <span class="number">4321520</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">9</span> seconds <span class="number">630</span> msec</span><br><span class="line">OK</span><br><span class="line">Time taken: <span class="number">19.868</span> seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后一组中间表指标，包含地理位置信息</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> bigdata.user_tag_value <span class="keyword">partition</span>(<span class="keyword">module</span>=<span class="string">'geography_info'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="string">'province'</span> <span class="keyword">as</span> <span class="keyword">key</span>,</span><br><span class="line">    province</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag <span class="keyword">desc</span>) <span class="keyword">as</span> order_rank,</span><br><span class="line">        address[<span class="string">'province'</span>] <span class="keyword">as</span> province</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        bigdata.weblog</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        active_name = <span class="string">'pay'</span>) t1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    order_rank = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p> 执行结果如下：</p>
 <figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; insert overwrite table bigdata.user_tag_value partition(<span class="keyword">module</span>=<span class="string">'geography_info'</span>)</span><br><span class="line">    &gt; <span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     <span class="string">'province'</span> <span class="keyword">as</span> key,</span><br><span class="line">    &gt;     province</span><br><span class="line">    &gt; <span class="keyword">from</span></span><br><span class="line">    &gt;     (<span class="keyword">select</span></span><br><span class="line">    &gt;         user_id,</span><br><span class="line">    &gt;         row_number() over (partition <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> time_tag <span class="keyword">desc</span>) <span class="keyword">as</span> order_rank,</span><br><span class="line">    &gt;         address[<span class="string">'province'</span>] <span class="keyword">as</span> province</span><br><span class="line">    &gt;     <span class="keyword">from</span></span><br><span class="line">    &gt;         bigdata.weblog</span><br><span class="line">    &gt;     <span class="keyword">where</span></span><br><span class="line">    &gt;         active_name = <span class="string">'pay'</span>) t1</span><br><span class="line">    &gt; <span class="keyword">where</span></span><br><span class="line">    &gt;     order_rank = <span class="number">1</span>;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190107230037_ea3bdeb8-<span class="number">6</span>a0b-<span class="number">4111</span>-bb4c-<span class="number">9</span>df76751b914</span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Launching Job <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">Number <span class="keyword">of</span> reduce tasks <span class="keyword">not</span> specified. Estimated <span class="keyword">from</span> input data size: <span class="number">7</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">set</span> a constant number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21574, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21574/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21574</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage-<span class="number">1</span>: number <span class="keyword">of</span> mappers: <span class="number">6</span>; number <span class="keyword">of</span> reducers: <span class="number">7</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">43</span>,<span class="number">782</span> Stage-<span class="number">1</span> map = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">52</span>,<span class="number">071</span> Stage-<span class="number">1</span> map = <span class="number">17</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">6.24</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">54</span>,<span class="number">146</span> Stage-<span class="number">1</span> map = <span class="number">18</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">17.19</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">55</span>,<span class="number">190</span> Stage-<span class="number">1</span> map = <span class="number">20</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">60.04</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">57</span>,<span class="number">268</span> Stage-<span class="number">1</span> map = <span class="number">26</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">66.89</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">58</span>,<span class="number">329</span> Stage-<span class="number">1</span> map = <span class="number">40</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">77.07</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">00</span>,<span class="number">383</span> Stage-<span class="number">1</span> map = <span class="number">48</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">90.85</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">02</span>,<span class="number">481</span> Stage-<span class="number">1</span> map = <span class="number">70</span>%,  reduce = <span class="number">2</span>%, Cumulative CPU <span class="number">98.15</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">03</span>,<span class="number">592</span> Stage-<span class="number">1</span> map = <span class="number">80</span>%,  reduce = <span class="number">7</span>%, Cumulative CPU <span class="number">108.43</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">04</span>,<span class="number">632</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">10</span>%, Cumulative CPU <span class="number">110.95</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">05</span>,<span class="number">662</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">19</span>%, Cumulative CPU <span class="number">111.22</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">06</span>,<span class="number">701</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">43</span>%, Cumulative CPU <span class="number">117.57</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">07</span>,<span class="number">727</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">143.3</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">2</span> minutes <span class="number">23</span> seconds <span class="number">300</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21574</span><br><span class="line">Loading data <span class="keyword">to</span> table bigdata.user_tag_value partition (<span class="keyword">module</span>=geography_info)</span><br><span class="line">Partition bigdata.user_tag_value<span class="comment">&#123;module=geography_info&#125;</span> stats: [numFiles=<span class="number">7</span>, numRows=<span class="number">40460</span>, totalSize=<span class="number">2632564</span>, rawDataSize=<span class="number">0</span>]</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-<span class="number">1</span>: Map: <span class="number">6</span>  Reduce: <span class="number">7</span>   Cumulative CPU: <span class="number">143.3</span> sec   HDFS <span class="keyword">Read</span>: <span class="number">1571466260</span> HDFS <span class="keyword">Write</span>: <span class="number">2633278</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">2</span> minutes <span class="number">23</span> seconds <span class="number">300</span> msec</span><br><span class="line">OK</span><br><span class="line">Time taken: <span class="number">33.794</span> seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后一步，将中间表通过行专列，将其转换成一个大宽表</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> bigdata.user_profile</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">concat</span>(<span class="string">'&#123;'</span>, <span class="keyword">concat_ws</span>(<span class="string">','</span>, collect_set(<span class="keyword">concat</span>(<span class="string">'"'</span>, tag, <span class="string">'"'</span>, <span class="string">':'</span>, <span class="string">'"'</span>, <span class="keyword">value</span>, <span class="string">'"'</span>))), <span class="string">'&#125;'</span>) <span class="keyword">as</span> json_string</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.user_tag_value</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    user_id;</span><br></pre></td></tr></table></figure>
<p> 执行结果：</p>
 <figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; insert overwrite table bigdata.user_profile</span><br><span class="line">    &gt; <span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     <span class="keyword">concat</span>(<span class="string">'&#123;'</span>, concat_ws(<span class="string">','</span>, collect_set(<span class="keyword">concat</span>(<span class="string">'"'</span>, tag, <span class="string">'"'</span>, <span class="string">':'</span>, <span class="string">'"'</span>, value, <span class="string">'"'</span>))), <span class="string">'&#125;'</span>) <span class="keyword">as</span> json_string</span><br><span class="line">    &gt; <span class="keyword">from</span></span><br><span class="line">    &gt;     bigdata.user_tag_value</span><br><span class="line">    &gt; <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    &gt;     user_id;</span><br><span class="line">Query ID = <span class="number">1015146591</span>_20190107230714_4f1ca497-<span class="number">377</span>e-<span class="number">4</span>c69-<span class="number">9500</span>-<span class="number">23</span>d0640447f8</span><br><span class="line">Total jobs = <span class="number">1</span></span><br><span class="line">Launching Job <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">Number <span class="keyword">of</span> reduce tasks <span class="keyword">not</span> specified. Estimated <span class="keyword">from</span> input data size: <span class="number">1</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.bytes.per.reducer=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> hive.exec.reducers.max=&lt;number&gt;</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">set</span> a constant number <span class="keyword">of</span> reducers:</span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=&lt;number&gt;</span><br><span class="line">Starting Job = job_1535253853575_21593, Tracking URL = http:<span class="comment">//bigdata0.novalocal:8088/proxy/application_1535253853575_21593/</span></span><br><span class="line">Kill Command = /home/hadoop/hadoop-current/bin/hadoop job  -kill job_1535253853575_21593</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage-<span class="number">1</span>: number <span class="keyword">of</span> mappers: <span class="number">2</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">44</span>,<span class="number">411</span> Stage-<span class="number">1</span> map = <span class="number">0</span>%,  reduce = <span class="number">0</span>%</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">51</span>,<span class="number">719</span> Stage-<span class="number">1</span> map = <span class="number">50</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">3.13</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">55</span>,<span class="number">855</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">0</span>%, Cumulative CPU <span class="number">13.74</span> sec</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">07</span> <span class="number">23</span>:<span class="number">08</span>:<span class="number">02</span>,<span class="number">102</span> Stage-<span class="number">1</span> map = <span class="number">100</span>%,  reduce = <span class="number">100</span>%, Cumulative CPU <span class="number">22.6</span> sec</span><br><span class="line">MapReduce Total cumulative CPU time: <span class="number">22</span> seconds <span class="number">600</span> msec</span><br><span class="line">Ended Job = job_1535253853575_21593</span><br><span class="line">Loading data <span class="keyword">to</span> table bigdata.user_profile</span><br><span class="line">Table bigdata.user_profile stats: [numFiles=<span class="number">0</span>, numRows=<span class="number">58424</span>, totalSize=<span class="number">0</span>, rawDataSize=<span class="number">0</span>]</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage-Stage-<span class="number">1</span>: Map: <span class="number">2</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">22.6</span> sec   HDFS <span class="keyword">Read</span>: <span class="number">14766922</span> HDFS <span class="keyword">Write</span>: <span class="number">8294101</span> SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: <span class="number">22</span> seconds <span class="number">600</span> msec</span><br><span class="line">OK</span><br><span class="line">Time taken: <span class="number">49.459</span> seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看一下最终得到的大宽表是怎样的结构：</p>
 <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> bigdata.user_profile <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p> 执行结果：</p>
 <figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select * from bigdata.user_profile limit <span class="number">10</span>;</span><br><span class="line">OK</span><br><span class="line"><span class="number">000152</span>8165978481        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"43.0"</span>,<span class="string">"device_type"</span>:<span class="string">"Android"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-05-29"</span>&#125;</span><br><span class="line"><span class="number">000152</span>8166031761        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"44.0"</span>,<span class="string">"device_type"</span>:<span class="string">"WEB"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-04-25"</span>,<span class="string">"first_order_time"</span>:<span class="string">"1527578321393"</span>,<span class="string">"last_order_time"</span>:<span class="string">"1527578321393"</span>,<span class="string">"order_count"</span>:<span class="string">"1"</span>,<span class="string">"order_sum"</span>:<span class="string">"40.0"</span>,<span class="string">"province"</span>:<span class="string">"山西"</span>&#125;</span><br><span class="line"><span class="number">000152</span>816605839<span class="number">0</span>        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"26.0"</span>,<span class="string">"device_type"</span>:<span class="string">"WEB"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-04-09"</span>&#125;</span><br><span class="line"><span class="number">000152</span>8166157577        &#123;<span class="string">"gender"</span>:<span class="string">"男"</span>,<span class="string">"age"</span>:<span class="string">"27.0"</span>,<span class="string">"device_type"</span>:<span class="string">"WEB"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-01-10"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>897045258        &#123;<span class="string">"gender"</span>:<span class="string">"男"</span>,<span class="string">"age"</span>:<span class="string">"34.0"</span>,<span class="string">"device_type"</span>:<span class="string">"IPhone"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-03-26"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>897084097        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"39.0"</span>,<span class="string">"device_type"</span>:<span class="string">"WEB"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-05-30"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>89709893<span class="number">0</span>        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"21.0"</span>,<span class="string">"device_type"</span>:<span class="string">"IPhone"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-02-13"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>897281376        &#123;<span class="string">"gender"</span>:<span class="string">"男"</span>,<span class="string">"age"</span>:<span class="string">"21.0"</span>,<span class="string">"device_type"</span>:<span class="string">"IPhone"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-05-30"</span>,<span class="string">"first_order_time"</span>:<span class="string">"1527642284658"</span>,<span class="string">"last_order_time"</span>:<span class="string">"1527642284658"</span>,<span class="string">"order_count"</span>:<span class="string">"1"</span>,<span class="string">"order_sum"</span>:<span class="string">"64.0"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>897292909        &#123;<span class="string">"gender"</span>:<span class="string">"男"</span>,<span class="string">"age"</span>:<span class="string">"40.0"</span>,<span class="string">"device_type"</span>:<span class="string">"WEB"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-03-03"</span>,<span class="string">"first_order_time"</span>:<span class="string">"1527639077523"</span>,<span class="string">"last_order_time"</span>:<span class="string">"1527639077523"</span>,<span class="string">"order_count"</span>:<span class="string">"1"</span>,<span class="string">"order_sum"</span>:<span class="string">"25.0"</span>&#125;</span><br><span class="line"><span class="number">0001531</span>897299559        &#123;<span class="string">"gender"</span>:<span class="string">"女"</span>,<span class="string">"age"</span>:<span class="string">"35.0"</span>,<span class="string">"device_type"</span>:<span class="string">"IPhone"</span>,<span class="string">"register_day"</span>:<span class="string">"2018-01-07"</span>,<span class="string">"first_order_time"</span>:<span class="string">"1527637397062"</span>,<span class="string">"last_order_time"</span>:<span class="string">"1527637397062"</span>,<span class="string">"order_count"</span>:<span class="string">"1"</span>,<span class="string">"order_sum"</span>:<span class="string">"86.0"</span>&#125;</span><br><span class="line">Time taken: <span class="number">0</span>.<span class="number">037</span> seconds, Fetched: <span class="number">10</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用大宽表举例：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id,</span><br><span class="line">    get_json_object(profile, <span class="string">'$.gender'</span>),</span><br><span class="line">    get_json_object(profile, <span class="string">'$.age'</span>),</span><br><span class="line">    get_json_object(profile, <span class="string">'$.province'</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.user_profile</span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p> 执行结果：</p>
 <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; <span class="keyword">select</span></span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     get_json_object(profile, <span class="string">'$.gender'</span>),</span><br><span class="line">    &gt;     get_json_object(profile, <span class="string">'$.age'</span>),</span><br><span class="line">    &gt;     get_json_object(profile, <span class="string">'$.province'</span>)</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt;     bigdata.user_profile</span><br><span class="line">    &gt; limit <span class="number">10</span><span class="comment">;</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">0001528165978481</span>        女      <span class="number">43.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001528166031761</span>        女      <span class="number">44.0</span>    山西</span><br><span class="line"><span class="number">0001528166058390</span>        女      <span class="number">26.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001528166157577</span>        男      <span class="number">27.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897045258</span>        男      <span class="number">34.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897084097</span>        女      <span class="number">39.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897098930</span>        女      <span class="number">21.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897281376</span>        男      <span class="number">21.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897292909</span>        男      <span class="number">40.0</span>    <span class="literal">NULL</span></span><br><span class="line"><span class="number">0001531897299559</span>        女      <span class="number">35.0</span>    <span class="literal">NULL</span></span><br><span class="line">Time taken: <span class="number">0.224</span> seconds, Fetched: <span class="number">10</span> row(s)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>使用方式二行列转换的方式的好处：</p>
<ul>
<li><p>灵活增加指标而不改动表结构</p>
</li>
<li><p>可以并行计算指标，运行效率高</p>
</li>
<li><p>字段输出顺序灵活可调</p>
</li>
</ul>
<h1 id="用户自定义函数UDF的使用"><a href="#用户自定义函数UDF的使用" class="headerlink" title="用户自定义函数UDF的使用"></a>用户自定义函数UDF的使用</h1><p>Hive自带了很多函数，但是还是有些业务场景是hive自带函数无法满足的，这时就需要用根据业务户编写自定义函数以满足业务需要。</p>
<h2 id="根据用户生日解析星座"><a href="#根据用户生日解析星座" class="headerlink" title="根据用户生日解析星座"></a>根据用户生日解析星座</h2><p>Hive中并没有将用户生日解析成星座的函数，如果不自定义函数，就需要在sql中写一堆case…when…进行判断，就如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case...when...</span><br><span class="line">case...when...</span><br><span class="line">case...when...</span><br><span class="line">case...when...</span><br><span class="line">case...when...</span><br><span class="line">case...when...</span><br></pre></td></tr></table></figure>
<p>这种方式可以实现功能，但是每次在这种场景下都要书写这没多sql语句，很麻烦。</p>
<p>可以将这些语句封装成用户自定义函数，每次需要将用户生日转换成星座的时候调用这个自定义的函数就可以了，省力，也不容易出错。</p>
<h2 id="用户自定义函数UDF"><a href="#用户自定义函数UDF" class="headerlink" title="用户自定义函数UDF"></a>用户自定义函数UDF</h2><p>用户自定义函数创建步骤：</p>
<ul>
<li><p>继承UDF类，并实现evaluate函数</p>
</li>
<li><p>编译成jar包</p>
</li>
<li><p>hive会话中加入jar包</p>
</li>
<li><p>create function定义函数</p>
</li>
</ul>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><ol>
<li><p>在MR课程创建的工程中的pom中添加相关依赖，如下：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 为防止中文出现乱码，在pom中指定编码格式为UTF-8:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">maven.compiler.encoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写计算星座的函数：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bigdata.etl.udf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDFZodiac</span> <span class="keyword">extends</span> <span class="title">UDF</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SimpleDateFormat df;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UDFZodiac</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">evaluate</span><span class="params">(Calendar bday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.evaluate(bday.get(Calendar.MONTH + <span class="number">1</span>), bday.get(Calendar.DAY_OF_MONTH));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">evaluate</span><span class="params">(String bday)</span> </span>&#123;</span><br><span class="line">        Date date = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            date = df.parse(bday);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(date);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.evaluate(calendar.get(Calendar.MONTH) + <span class="number">1</span>, calendar.get(Calendar.DAY_OF_MONTH));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">evaluate</span><span class="params">(Integer month, Integer day)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"摩羯座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"水瓶座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">19</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"水瓶座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"双鱼座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">21</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"双鱼座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"白羊座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"白羊座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"金牛座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">21</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"金牛座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"双子座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">6</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">21</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"双子座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"巨蟹座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"巨蟹座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"狮子座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"狮子座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"处女座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">9</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"处女座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"天秤座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"天秤座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"天蝎座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"天蝎座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"射手座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month == <span class="number">12</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (day &lt; <span class="number">23</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"射手座"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"摩羯座"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包程序上传到bigdata4,并上传到HDFS上：</p>
<p> 这里我在打包的时候出了个问题，提示：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to <span class="keyword">execute</span> goal <span class="keyword">on</span> <span class="keyword">project</span> etl: Could <span class="keyword">not</span> resolve dependencies <span class="keyword">for</span> <span class="keyword">project</span> netease.bigdata.course:etl:jar:<span class="number">1.0</span>: Could <span class="keyword">not</span> find artifact org.pentaho:pentaho-aggdesigner-algorithm:jar:<span class="number">5.1</span><span class="number">.5</span>-jhyde <span class="keyword">in</span> nexus-aliyun (<span class="keyword">http</span>://maven.aliyun.com/nexus/<span class="keyword">content</span>/<span class="keyword">groups</span>/<span class="keyword">public</span>) -&gt; [<span class="keyword">Help</span> <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p> 我把mvn从阿里的源改为官方的后可以正常打包了，如果有相关问题可以参考一下这个方法。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[1015146591@bigdata4 ~]$ hadoop fs -mkdir /user/1015146591/hive/jar</span><br><span class="line">[1015146591@bigdata4 ~]$ hadoop fs -put jars/etl-1.0-jar-with-dependencies.jar /user/1015146591/hive/jar/</span><br><span class="line">[1015146591@bigdata4 ~]$ hadoop fs -ls /user/1015146591/hive/jar</span><br><span class="line">Found 1 items</span><br><span class="line">-rw-r-----   3 1015146591 supergroup     439380 2019-01-08 10:16 /user/1015146591/hive/jar/etl-1.0-jar-with-dependencies.jar</span><br><span class="line">[1015146591@bigdata4 ~]$ mvn clean package</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动hive，在会话窗口中加载刚刚上传的jar包：</p>
 <figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; add jar hdfs:/user/<span class="number">1015146591</span>/hive/jar/etl-<span class="number">1.0</span>-jar-with-<span class="built_in">dependencies</span>.jar;</span><br><span class="line">converting to <span class="built_in">local</span> hdfs:/user/<span class="number">1015146591</span>/hive/jar/etl-<span class="number">1.0</span>-jar-with-<span class="built_in">dependencies</span>.jar</span><br><span class="line">Added [/mnt/home/<span class="number">1015146591</span>/apps/hive-<span class="number">1.2</span>.2/tmp/91095efc-<span class="number">87b4</span>-4b5c-b52d-3e0e886f69ff_resources/etl-<span class="number">1.0</span>-jar-with-<span class="built_in">dependencies</span>.jar] to class path</span><br><span class="line">Added resources: [hdfs:/user/<span class="number">1015146591</span>/hive/jar/etl-<span class="number">1.0</span>-jar-with-<span class="built_in">dependencies</span>.jar]</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建临时函数：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; create temporary function udf_zodiac as 'com.bigdata.etl.udf.UDFZodiac';</span><br><span class="line">OK</span><br><span class="line">Time taken: 0.78 seconds</span><br></pre></td></tr></table></figure>
</li>
<li><p>在查询语句中使用刚才编写的函数：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id,</span><br><span class="line">    from_unixtime(<span class="keyword">cast</span>(birthday/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>), <span class="string">'yyyy-MM-dd'</span>),</span><br><span class="line">    udf_zodiac(from_unixtime(<span class="keyword">cast</span>(birthday/<span class="number">1000</span> <span class="keyword">as</span> <span class="built_in">bigint</span>), <span class="string">'yyyy-MM-dd'</span>))</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.member</span><br><span class="line"><span class="keyword">limit</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p> 查看运行结果：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select </span><br><span class="line">    &gt;     user_id,</span><br><span class="line">    &gt;     from_unixtime(cast(birthday/1000 as bigint), 'yyyy-MM-dd'),</span><br><span class="line">    &gt;     udf_zodiac(from_unixtime(cast(birthday/1000 as bigint), 'yyyy-MM-dd'))</span><br><span class="line">    &gt; from</span><br><span class="line">    &gt;     bigdata.member</span><br><span class="line">    &gt; limit 20;</span><br><span class="line">OK</span><br><span class="line">0001528166058390	1992-04-26	金牛座</span><br><span class="line">0001531897045258	1984-02-05	水瓶座</span><br><span class="line">0001531897084097	1979-01-15	摩羯座</span><br><span class="line">0001531897369998	1999-02-23	双鱼座</span><br><span class="line">0001531898051786	1983-06-15	双子座</span><br><span class="line">0001531898202634	1982-11-11	天蝎座</span><br><span class="line">0001531898252101	1986-12-26	摩羯座</span><br><span class="line">0001531898353851	2001-05-16	金牛座</span><br><span class="line">0001531898480773	1995-01-10	摩羯座</span><br><span class="line">0001531898489619	1998-03-26	白羊座</span><br><span class="line">0001531898533512	1997-02-13	水瓶座</span><br><span class="line">0011528165770489	1976-09-30	天秤座</span><br><span class="line">0011528165983913	1992-01-02	摩羯座</span><br><span class="line">0011528166026392	1989-10-26	天蝎座</span><br><span class="line">0011528166029056	1974-07-28	狮子座</span><br><span class="line">0011528166125503	1983-02-26	双鱼座</span><br><span class="line">0011528166158037	1995-01-15	摩羯座</span><br><span class="line">0011528166191049	1985-04-20	金牛座</span><br><span class="line">0011528166197979	2001-02-12	水瓶座</span><br><span class="line">0011531897025121	2001-04-22	金牛座</span><br><span class="line">Time taken: 1.258 seconds, Fetched: 20 row(s)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>可以看到用户星座已经被成功解析出来了，也就是我们自己编写的函数可是正常使用了。</p>
<h2 id="工程代码"><a href="#工程代码" class="headerlink" title="工程代码"></a>工程代码</h2><p>工程代码：<a href="https://github.com/jiaoqiyuan/163-bigdate-note/tree/master/%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2%EF%BC%9AHive/etl" target="_blank" rel="noopener"><strong>点这里</strong></a> 。</p>
<h1 id="Hive优化案例"><a href="#Hive优化案例" class="headerlink" title="Hive优化案例"></a>Hive优化案例</h1><pre><code>SQL写法不同，运行的效率也会出现巨大差异
</code></pre><h2 id="影响运行效率的因素与优化原则"><a href="#影响运行效率的因素与优化原则" class="headerlink" title="影响运行效率的因素与优化原则"></a>影响运行效率的因素与优化原则</h2><p>最重要的两个因素（其实也就是影响MR的两个因素，因为Hive的SQL语句最终要转化成MR执行）：</p>
<ul>
<li><p>Job数量的多少</p>
</li>
<li><p>数据分布是否均衡</p>
</li>
</ul>
<p>有时数据量不是很大，但是需要关联很多张表时，就需要启动很多个job，那么消耗的时间就比较长。</p>
<p>如果数据不能均匀分布在每个结点，而是某一个节点承担了过多的计算任务，那么在其他节点都完成计算任务后，计算任务较多的节点很长时间都没有计算完成，那么整个任务就卡在了这里。</p>
<p>优化方法：</p>
<ul>
<li><p>减少Job数量</p>
</li>
<li><p>减少数据倾斜</p>
</li>
</ul>
<h2 id="分区和裁剪"><a href="#分区和裁剪" class="headerlink" title="分区和裁剪"></a>分区和裁剪</h2><p>在日常编写HiveSQL时，当对两表做关联的时候，如果涉及到分区表，那么就尽量将分区字段放到子语句当中，这样，两表在做关联的时候数据量已经得到压缩。</p>
<p>另外在select的时候尽量只选取我们需要的字段，这样可以减少读入字段和分区的数目，节省中间存储和数据整合的开销。应尽量减少select *的使用。</p>
<p>例如下面的SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    t1.user_id,</span><br><span class="line">    gender,</span><br><span class="line">    req_url</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, req_url <span class="keyword">from</span> bigdata.weblog <span class="keyword">where</span> <span class="keyword">day</span>=<span class="string">'2018-05-29'</span>) t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, gender <span class="keyword">from</span> bigdata.member) t2</span><br><span class="line"><span class="keyword">on</span> t1.user_id=t2.user_id</span><br></pre></td></tr></table></figure>
<h2 id="避免迪卡尔及积"><a href="#避免迪卡尔及积" class="headerlink" title="避免迪卡尔及积"></a>避免迪卡尔及积</h2><p>如果在两表关联时发生多对多的关联，多对多是指关联字段在量表中均多次出现，比如在orders表中，同一个用户可能有多笔订单记录;在用户标签库user_tag_value中同一个用户可能会有多个标签。</p>
<p>这两张表（orders和user_tag_value）以user_id做关联时，就会产生迪卡尔积，就会产生大量的重复记录，这种情况是应该尽量避免的。</p>
<p><strong>避免多对多关联</strong></p>
<p>下面这种SQL应该尽量避免：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, pay_amount <span class="keyword">from</span> bigdata.orders) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, tag, <span class="keyword">value</span> <span class="keyword">from</span> bigdata.user_tag_value) t2</span><br><span class="line"><span class="keyword">on</span> t2.user_id=t2.user_id</span><br></pre></td></tr></table></figure>
<h2 id="替代union"><a href="#替代union" class="headerlink" title="替代union"></a>替代union</h2><p>多次使用union会导致hive多次执行去重操作，导致运行效率比较低。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_id</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">from</span> ...)</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">from</span> ...)</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">from</span> ...)</span><br></pre></td></tr></table></figure>
<p>一个更好的替代方法是使用union all，union all与union的差别是union all不会执行去重操作，相同的记录会得到保留，然后在最外层使用一次去重即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">distinct</span> user_id</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id <span class="keyword">from</span> ...</span><br><span class="line">    <span class="keyword">union</span> all</span><br><span class="line">    <span class="keyword">select</span> user_id <span class="keyword">from</span> ...</span><br><span class="line">    <span class="keyword">union</span> all</span><br><span class="line">    <span class="keyword">select</span> user_id <span class="keyword">from</span> ...)</span><br></pre></td></tr></table></figure>
<h2 id="减少count-distinct"><a href="#减少count-distinct" class="headerlink" title="减少count distinct"></a>减少count distinct</h2><p>在使用count和distinct的时候，每次使用都会调用一个Reduce任务来完成，一个Reduce任务如果处理的数据量过大会导致整个job难以完成。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.weblog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    active_name=<span class="string">'order'</span></span><br></pre></td></tr></table></figure>
<p>如果数据量比较大，我们可以使用count…group by来优化：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    bigdata.weblog</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    active_name = <span class="string">'order'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    user_id</span><br></pre></td></tr></table></figure>
<h1 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h1><p>这就是我在学习Hive过程中的笔记，里面包含的一些建表数据信息存放在<a href="https://pan.baidu.com/s/19dcVUGVagvNgyhwsULI3zg" target="_blank" rel="noopener">这个地址</a>，可以自行下载测试。</p>
<p>对比之前写MapReduce程序和现在使用Hive处理数据，可以发现Hive真的是更装了很多，也简化了很多，非常适合对代码编写不是特别熟悉的分析人员使用，当然开发人员也可以使用Hive来简化数据验证阶段的流程，避免繁琐地编写MapRedcue代码。</p>
<p><strong>总得来说，Hive是个不错的使用SQL语言进行离线数据分析工具。</strong></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/05/Hive常用函数总结/" rel="next" title="Hive常用函数总结">
                <i class="fa fa-chevron-left"></i> Hive常用函数总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/11/我不喜欢Python的8个理由-译/" rel="prev" title="8 Reasons Python Sucks-译">
                8 Reasons Python Sucks-译 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar-6.png" alt="Jony Chiao">
            
              <p class="site-author-name" itemprop="name">Jony Chiao</p>
              <p class="site-description motion-element" itemprop="description">bulabula</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">83</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jiaoqiyuan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jijujiu@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#集群环境"><span class="nav-number">1.</span> <span class="nav-text">集群环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#相关数据资源"><span class="nav-number">2.</span> <span class="nav-text">相关数据资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hive解决了什么问题"><span class="nav-number">3.</span> <span class="nav-text">Hive解决了什么问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#从MR到Hive"><span class="nav-number">3.1.</span> <span class="nav-text">从MR到Hive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#化繁为简的Hive"><span class="nav-number">3.2.</span> <span class="nav-text">化繁为简的Hive</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hive擅长什么"><span class="nav-number">4.</span> <span class="nav-text">Hive擅长什么</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive的优势"><span class="nav-number">4.1.</span> <span class="nav-text">Hive的优势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive的局限"><span class="nav-number">4.2.</span> <span class="nav-text">Hive的局限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive的适用场景"><span class="nav-number">4.3.</span> <span class="nav-text">Hive的适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive数据结构与数据仓库"><span class="nav-number">4.4.</span> <span class="nav-text">Hive数据结构与数据仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据仓库"><span class="nav-number">4.5.</span> <span class="nav-text">数据仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#传统数据仓库"><span class="nav-number">4.6.</span> <span class="nav-text">传统数据仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive架构（3-1）"><span class="nav-number">4.7.</span> <span class="nav-text">Hive架构（3+1）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive运行流程"><span class="nav-number">4.8.</span> <span class="nav-text">Hive运行流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据模型与元数据"><span class="nav-number">4.9.</span> <span class="nav-text">数据模型与元数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive数据模型"><span class="nav-number">4.10.</span> <span class="nav-text">Hive数据模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#元数据"><span class="nav-number">4.11.</span> <span class="nav-text">元数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive元数据表"><span class="nav-number">4.12.</span> <span class="nav-text">Hive元数据表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hive安装与配置"><span class="nav-number">5.</span> <span class="nav-text">Hive安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive安装依赖"><span class="nav-number">5.1.</span> <span class="nav-text">Hive安装依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive安装与配置-1"><span class="nav-number">5.2.</span> <span class="nav-text">Hive安装与配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建和管理Hive中的数据"><span class="nav-number">6.</span> <span class="nav-text">创建和管理Hive中的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive中创建数据库"><span class="nav-number">6.1.</span> <span class="nav-text">Hive中创建数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置hive使用mysql存储元数据"><span class="nav-number">6.2.</span> <span class="nav-text">配置hive使用mysql存储元数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#写一个基本的查询语句"><span class="nav-number">7.</span> <span class="nav-text">写一个基本的查询语句</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SELECT的用法"><span class="nav-number">7.1.</span> <span class="nav-text">SELECT的用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WHERE的用法"><span class="nav-number">7.2.</span> <span class="nav-text">WHERE的用法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#子查询和关联表"><span class="nav-number">8.</span> <span class="nav-text">子查询和关联表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关联表JOIN"><span class="nav-number">8.1.</span> <span class="nav-text">关联表JOIN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">8.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用简单函数"><span class="nav-number">9.</span> <span class="nav-text">使用简单函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive函数分类"><span class="nav-number">9.1.</span> <span class="nav-text">Hive函数分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单函数"><span class="nav-number">9.2.</span> <span class="nav-text">简单函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive自带函数"><span class="nav-number">9.3.</span> <span class="nav-text">Hive自带函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用聚合函数"><span class="nav-number">10.</span> <span class="nav-text">使用聚合函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive函数分类-1"><span class="nav-number">10.1.</span> <span class="nav-text">Hive函数分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合函数"><span class="nav-number">10.2.</span> <span class="nav-text">聚合函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#利用正则表达精确提取信息"><span class="nav-number">11.</span> <span class="nav-text">利用正则表达精确提取信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#原始日志数据的局限"><span class="nav-number">11.1.</span> <span class="nav-text">原始日志数据的局限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#正则表达式"><span class="nav-number">11.2.</span> <span class="nav-text">正则表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计算商品访问量"><span class="nav-number">11.3.</span> <span class="nav-text">计算商品访问量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用窗口函数"><span class="nav-number">12.</span> <span class="nav-text">使用窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数"><span class="nav-number">12.1.</span> <span class="nav-text">窗口函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下单用户路径分析"><span class="nav-number">12.2.</span> <span class="nav-text">下单用户路径分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数的语法"><span class="nav-number">12.3.</span> <span class="nav-text">窗口函数的语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际操作"><span class="nav-number">12.4.</span> <span class="nav-text">实际操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#行转列与列转行"><span class="nav-number">13.</span> <span class="nav-text">行转列与列转行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#行转列业务场景"><span class="nav-number">13.1.</span> <span class="nav-text">行转列业务场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive中行转列函数"><span class="nav-number">13.2.</span> <span class="nav-text">Hive中行转列函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户画像"><span class="nav-number">13.3.</span> <span class="nav-text">用户画像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#计算N个指标的实现方式一"><span class="nav-number">13.3.1.</span> <span class="nav-text">计算N个指标的实现方式一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#计算N个指标的实现方式二"><span class="nav-number">13.3.2.</span> <span class="nav-text">计算N个指标的实现方式二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-1"><span class="nav-number">13.3.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#用户自定义函数UDF的使用"><span class="nav-number">14.</span> <span class="nav-text">用户自定义函数UDF的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#根据用户生日解析星座"><span class="nav-number">14.1.</span> <span class="nav-text">根据用户生日解析星座</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户自定义函数UDF"><span class="nav-number">14.2.</span> <span class="nav-text">用户自定义函数UDF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实例"><span class="nav-number">14.3.</span> <span class="nav-text">实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工程代码"><span class="nav-number">14.4.</span> <span class="nav-text">工程代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hive优化案例"><span class="nav-number">15.</span> <span class="nav-text">Hive优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#影响运行效率的因素与优化原则"><span class="nav-number">15.1.</span> <span class="nav-text">影响运行效率的因素与优化原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分区和裁剪"><span class="nav-number">15.2.</span> <span class="nav-text">分区和裁剪</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免迪卡尔及积"><span class="nav-number">15.3.</span> <span class="nav-text">避免迪卡尔及积</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#替代union"><span class="nav-number">15.4.</span> <span class="nav-text">替代union</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#减少count-distinct"><span class="nav-number">15.5.</span> <span class="nav-text">减少count distinct</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结-2"><span class="nav-number">16.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jony Chiao</span>

  
</div>





        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
