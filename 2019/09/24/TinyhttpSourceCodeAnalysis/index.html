<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/avatar-6.png?v=5.1.4" color="#222">





  <meta name="keywords" content="linux,C,">










<meta name="description" content="TinyHttpd æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å†™çš„åŠå…¶ç®€æ´çš„ HTTP æœåŠ¡ç¨‹åºï¼Œä¸€å…±åªæœ‰ 500 è¡Œå·¦å³ä»£ç ï¼Œéå¸¸é€‚åˆæ‹¿æ¥å­¦ä¹  HTTPã€‚  è¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è‡ªå·±ä¸€è¾¹å­¦ä¹ ä¸€éè®°å½•çš„å­¦ä¹ ç¬”è®°ã€‚ 2020-4-18">
<meta name="keywords" content="linux,C">
<meta property="og:type" content="article">
<meta property="og:title" content="Tinyhttpdæºç è§£æ">
<meta property="og:url" content="http://yoursite.com/2019/09/24/TinyhttpSourceCodeAnalysis/index.html">
<meta property="og:site_name" content="My Love">
<meta property="og:description" content="TinyHttpd æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å†™çš„åŠå…¶ç®€æ´çš„ HTTP æœåŠ¡ç¨‹åºï¼Œä¸€å…±åªæœ‰ 500 è¡Œå·¦å³ä»£ç ï¼Œéå¸¸é€‚åˆæ‹¿æ¥å­¦ä¹  HTTPã€‚  è¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è‡ªå·±ä¸€è¾¹å­¦ä¹ ä¸€éè®°å½•çš„å­¦ä¹ ç¬”è®°ã€‚ 2020-4-18">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/tinyhttpd.png">
<meta property="og:updated_time" content="2020-04-27T03:00:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tinyhttpdæºç è§£æ">
<meta name="twitter:description" content="TinyHttpd æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å†™çš„åŠå…¶ç®€æ´çš„ HTTP æœåŠ¡ç¨‹åºï¼Œä¸€å…±åªæœ‰ 500 è¡Œå·¦å³ä»£ç ï¼Œéå¸¸é€‚åˆæ‹¿æ¥å­¦ä¹  HTTPã€‚  è¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è‡ªå·±ä¸€è¾¹å­¦ä¹ ä¸€éè®°å½•çš„å­¦ä¹ ç¬”è®°ã€‚ 2020-4-18">
<meta name="twitter:image" content="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/tinyhttpd.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/09/24/TinyhttpSourceCodeAnalysis/">





  <title>Tinyhttpdæºç è§£æ | My Love</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/jiaoqiyuan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Love</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">I will be stronger</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-ä¸»é¡µ">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            ä¸»é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-å…³äºæˆ‘">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            å…³äºæˆ‘
          </a>
        </li>
      
        
        <li class="menu-item menu-item-æ ‡ç­¾">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-åˆ†ç±»">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-å½’æ¡£">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/24/TinyhttpSourceCodeAnalysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jony Chiao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar-6.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Love">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tinyhttpdæºç è§£æ</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-09-24T07:47:36+08:00">
                2019-09-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/24/TinyhttpSourceCodeAnalysis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2019/09/24/TinyhttpSourceCodeAnalysis/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> æµè§ˆ
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>æ¬¡
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox" href="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/tinyhttpd.png" rel="gallery_ckhwqh4xo0058dnttt3b7qo4s" itemscope itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/tinyhttpd.png" itemprop="contentUrl">
              </a>
            
          

          
          </div>
        </div>
      

      
        <blockquote>
<p><a href="https://github.com/EZLippi/Tinyhttpd" target="_blank" rel="noopener">TinyHttpd</a> æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å†™çš„åŠå…¶ç®€æ´çš„ HTTP æœåŠ¡ç¨‹åºï¼Œä¸€å…±åªæœ‰ 500 è¡Œå·¦å³ä»£ç ï¼Œéå¸¸é€‚åˆæ‹¿æ¥å­¦ä¹  HTTPã€‚</p>
</blockquote>
<p>è¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è‡ªå·±ä¸€è¾¹å­¦ä¹ ä¸€éè®°å½•çš„å­¦ä¹ ç¬”è®°ã€‚</p>
<p>2020-4-18</p>
<hr>
<a id="more"></a>
<h2 id="æ•ˆæœæ¼”ç¤º"><a href="#æ•ˆæœæ¼”ç¤º" class="headerlink" title="æ•ˆæœæ¼”ç¤º"></a>æ•ˆæœæ¼”ç¤º</h2><ol>
<li><p>å…ˆ clone ä¸‹æºç åˆ°æœ¬åœ°ï¼š</p>
 <figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/EZLippi/Tinyhttpd.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿›å…¥ Tinyhttpd/htdocs ç›®å½•ï¼Œå°† cgi åç¼€ç»“å°¾çš„æ–‡ä»¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼ˆæˆ‘åœ¨è¿™é‡Œå›°æ‰°äº†å¥½ä¹…ï¼Œä¸€ç›´æ²¡èƒ½æ‰§è¡ŒæˆåŠŸçš„åŸå› å°±æ˜¯æ²¡æœ‰ç»™ cgi æ–‡ä»¶åŠ æ‰§è¡Œæƒé™ï¼‰ã€‚</p>
 <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> Tinyhttpd/htdocs</span><br><span class="line">chmod a+x *<span class="string">.cgi</span></span><br><span class="line"><span class="keyword">cd</span> <span class="string">../</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–è¯‘å¹¶è¿è¡Œ Tinyhttpdï¼š</p>
 <figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span></span><br><span class="line">./httpd</span><br></pre></td></tr></table></figure>
<p> æ‰§è¡Œç»“æœï¼š</p>
 <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ğŸ  jony@deepin # ./httpd </span><br><span class="line">httpd running on<span class="built_in"> port </span>4000</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨æµè§ˆå™¨è¾“å…¥ <code>localhost:4000</code>ï¼Œè¿›å…¥æµ‹è¯•é¡µé¢ï¼š</p>
<p> <img src="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/index.png" alt="index"></p>
<p> è¾“å…¥ <code>blue</code>ï¼Œç‚¹å‡»æäº¤ã€‚</p>
<p> <img src="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/color-cgi.png" alt="color"></p>
</li>
</ol>
<h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><p>TinyHttpd æºç åœ¨ githubä¸Šæœ‰ï¼Œè¿™é‡Œä¹Ÿè´´å‡ºæ¥å§ï¼Œåæ­£ä¹Ÿåªæœ‰500è¡Œå·¦å³ã€‚</p>
<p>æºç å®ç°çš„åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡æµè§ˆå™¨å‘ httpd æœåŠ¡å‘é€æ•°æ®è¯·æ±‚ï¼Œç„¶åæ¥æ”¶ httpd æœåŠ¡è¿”å›çš„æ•°æ®ã€‚</p>
<p>æ¯ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</p>
<ul>
<li><p>accept_request:  å¤„ç†ä»å¥—æ¥å­—ä¸Šç›‘å¬åˆ°çš„ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¾ˆå¤§ä¸€éƒ¨åˆ†åœ°ä½“ç°æœåŠ¡å™¨å¤„ç†è¯·æ±‚æµç¨‹ã€‚</p>
</li>
<li><p>bad_request: è¿”å›ç»™å®¢æˆ·ç«¯è¿™æ˜¯ä¸ªé”™è¯¯è¯·æ±‚ï¼ŒHTTP çŠ¶æ€å— 400 BAD REQUEST.</p>
</li>
<li><p>cat: è¯»å–æœåŠ¡å™¨ä¸ŠæŸä¸ªæ–‡ä»¶å†™åˆ° socket å¥—æ¥å­—ã€‚</p>
</li>
<li><p>cannot_execute: ä¸»è¦å¤„ç†å‘ç”Ÿåœ¨æ‰§è¡Œ cgi ç¨‹åºæ—¶å‡ºç°çš„é”™è¯¯ã€‚</p>
</li>
<li><p>error_die: æŠŠé”™è¯¯ä¿¡æ¯å†™åˆ° perror å¹¶é€€å‡ºã€‚</p>
</li>
<li><p>execute_cgi: è¿è¡Œ cgi ç¨‹åºçš„å¤„ç†ï¼Œä¹Ÿæ˜¯ä¸ªä¸»è¦å‡½æ•°ã€‚</p>
</li>
<li><p>get_line: è¯»å–å¥—æ¥å­—çš„ä¸€è¡Œï¼ŒæŠŠå›è½¦æ¢è¡Œç­‰æƒ…å†µéƒ½ç»Ÿä¸€ä¸ºæ¢è¡Œç¬¦ç»“æŸã€‚</p>
</li>
<li><p>headers: æŠŠ HTTP å“åº”çš„å¤´éƒ¨å†™åˆ°å¥—æ¥å­—ã€‚</p>
</li>
<li><p>not_found: ä¸»è¦å¤„ç†æ‰¾ä¸åˆ°è¯·æ±‚çš„æ–‡ä»¶æ—¶çš„æƒ…å†µã€‚</p>
</li>
<li><p>sever_file: è°ƒç”¨ cat æŠŠæœåŠ¡å™¨æ–‡ä»¶è¿”å›ç»™æµè§ˆå™¨ã€‚</p>
</li>
<li><p>startup: åˆå§‹åŒ– httpd æœåŠ¡ï¼ŒåŒ…æ‹¬å»ºç«‹å¥—æ¥å­—ï¼Œç»‘å®šç«¯å£ï¼Œè¿›è¡Œç›‘å¬ç­‰ã€‚</p>
</li>
<li><p>unimplemented: è¿”å›ç»™æµè§ˆå™¨è¡¨æ˜æ”¶åˆ°çš„ HTTP è¯·æ±‚æ‰€ç”¨çš„ method ä¸è¢«æ”¯æŒã€‚</p>
</li>
</ul>
<h3 id="main-å‡½æ•°å…¥æ‰‹"><a href="#main-å‡½æ•°å…¥æ‰‹" class="headerlink" title="main å‡½æ•°å…¥æ‰‹"></a>main å‡½æ•°å…¥æ‰‹</h3><p>æºç é˜…è¯»ä» <code>main</code> å‡½æ•°åˆ‡å…¥å³å¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæœåŠ¡ç«¯ socket æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">int</span> server_sock = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//æŒ‡å®šä½¿ç”¨ 4000 ç«¯å£</span></span><br><span class="line">    u_short port = <span class="number">4000</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºå®¢æˆ·ç«¯ socket æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">int</span> client_sock = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»º sockaddr_in å­˜å‚¨ IP å’Œç«¯å£ä¿¡æ¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_name</span>;</span></span><br><span class="line">    <span class="comment">//sockaddr_in é•¿åº¦</span></span><br><span class="line">    <span class="keyword">socklen_t</span>  client_name_len = <span class="keyword">sizeof</span>(client_name);</span><br><span class="line">    <span class="comment">//å¤šçº¿ç¨‹ ID</span></span><br><span class="line">    <span class="keyword">pthread_t</span> newthread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//startup å‡½æ•°ç”¨äºåˆå§‹åŒ– httpd æœåŠ¡ï¼ŒåŒ…æ‹¬å»ºç«‹å¥—æ¥å­—ï¼Œç»‘å®šç«¯å£ï¼Œè¿›è¡Œç›‘å¬ç­‰ã€‚</span></span><br><span class="line">    server_sock = startup(&amp;port);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"httpd running on port %d\n"</span>, port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//é˜»å¡ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">        client_sock = accept(server_sock,</span><br><span class="line">                (struct sockaddr *)&amp;client_name,</span><br><span class="line">                &amp;client_name_len);</span><br><span class="line">        <span class="keyword">if</span> (client_sock == <span class="number">-1</span>)</span><br><span class="line">            error_die(<span class="string">"accept"</span>);</span><br><span class="line">        <span class="comment">/* accept_request(&amp;client_sock); */</span></span><br><span class="line">        <span class="comment">//æ¯ç›‘å¬åˆ°ä¸€ä¸ªè¯·æ±‚å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ `accept_request` å¤„ç†è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;newthread , <span class="literal">NULL</span>, (<span class="keyword">void</span> *)accept_request, (<span class="keyword">void</span> *)(<span class="keyword">intptr_t</span>)client_sock) != <span class="number">0</span>)</span><br><span class="line">            perror(<span class="string">"pthread_create"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…³é—­è¿æ¥</span></span><br><span class="line">    close(server_sock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="startup-åˆå§‹åŒ–-httpd-æœåŠ¡"><a href="#startup-åˆå§‹åŒ–-httpd-æœåŠ¡" class="headerlink" title="startup åˆå§‹åŒ– httpd æœåŠ¡"></a><code>startup</code> åˆå§‹åŒ– httpd æœåŠ¡</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* This function starts the process of listening for web connections</span></span><br><span class="line"><span class="comment"> * on a specified port.  If the port is 0, then dynamically allocate a</span></span><br><span class="line"><span class="comment"> * port and modify the original port variable to reflect the actual</span></span><br><span class="line"><span class="comment"> * port.</span></span><br><span class="line"><span class="comment"> * Parameters: pointer to variable containing the port to connect on</span></span><br><span class="line"><span class="comment"> * Returns: the socket */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startup</span><span class="params">(u_short *port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> httpd = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºå­˜å‚¨ IP å’Œç«¯å£çš„ sockaddr_in ç»“æ„ä½“</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">name</span>;</span></span><br><span class="line">    <span class="comment">//åˆ›å»º socket è¿æ¥</span></span><br><span class="line">    httpd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (httpd == <span class="number">-1</span>)</span><br><span class="line">        error_die(<span class="string">"socket"</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));</span><br><span class="line">    name.sin_family = AF_INET;</span><br><span class="line">    name.sin_port = htons(*port);</span><br><span class="line">    name.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span> ((setsockopt(httpd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on))) &lt; <span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        error_die(<span class="string">"setsockopt failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bind(httpd, (struct sockaddr *)&amp;name, <span class="keyword">sizeof</span>(name)) &lt; <span class="number">0</span>)</span><br><span class="line">        error_die(<span class="string">"bind"</span>);</span><br><span class="line">    <span class="keyword">if</span> (*port == <span class="number">0</span>)  <span class="comment">/* if dynamically allocating a port å¦‚æœportä¸º0å°±éšæœºåˆ†é…ä¸€ä¸ªå¯ç”¨çš„å€¼ç»™port*/</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">socklen_t</span> namelen = <span class="keyword">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (getsockname(httpd, (struct sockaddr *)&amp;name, &amp;namelen) == <span class="number">-1</span>)</span><br><span class="line">            error_die(<span class="string">"getsockname"</span>);</span><br><span class="line">        *port = ntohs(name.sin_port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç›‘å¬ httpd è¿™ä¸ª socket</span></span><br><span class="line">    <span class="keyword">if</span> (listen(httpd, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        error_die(<span class="string">"listen"</span>);</span><br><span class="line">    <span class="keyword">return</span>(httpd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startup</code> å‡½æ•°ç”¨äºåˆå§‹åŒ– httpd æœåŠ¡ï¼ŒåŒ…æ‹¬å»ºç«‹å¥—æ¥å­—ï¼Œç»‘å®šç«¯å£ï¼Œè¿›è¡Œç›‘å¬ç­‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>PF_INET æŒ‡å®šä½¿ç”¨ ipv4ï¼ŒSOCK_STREAM æŒ‡å®šä½¿ç”¨ TCP é€šä¿¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•° 0 è¡¨ç¤ºæ ¹æ®å‰é¢ä¸¤ä¸ªå‚æ•°ä½¿ç”¨é»˜è®¤åè®®ã€‚</p>
<p><code>setsockopt</code> å‡½æ•°ç”¨äºè®¾ç½®å¥—æ¥å­—çš„å…³è”é¡¹ï¼Œä¸ºäº†æ“ä½œå¥—æ¥å­—å±‚çš„é€‰é¡¹ï¼Œåº”è¯¥å°†å±‚çš„å€¼æŒ‡å®šä¸ºSOL_SOCKETã€‚SO_REUSEADDR è¡¨ç¤ºå…è®¸é‡ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸¤åˆ†é’Ÿä¹‹åæ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚æœ‰å…³ SO_REUSEADDR çš„è¯´æ˜å¯ä»¥å‚è€ƒ <a href="https://www.cnblogs.com/qq78292959/archive/2013/01/18/2865926.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> ã€‚</p>
<p>è®¾ç½®å®Œ socket åä½¿ç”¨ bind ç»‘å®š socket åˆ°æŒ‡å®šåœ°å€ã€‚</p>
<p><code>listen</code> ä½¿å¾—ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ¥å—å…¶å®ƒè¿›ç¨‹çš„è¯·æ±‚ï¼Œä»è€Œæˆä¸ºä¸€ä¸ªæœåŠ¡å™¨è¿›ç¨‹ã€‚å…¶ä¸­ <code>listen</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º backlogã€‚</p>
<pre><code>è¿™ä¸ªå‚æ•°æ¶‰åŠåˆ°ä¸€äº›ç½‘ç»œçš„ç»†èŠ‚ã€‚åœ¨è¿›ç¨‹æ­£ç†ä¸€ä¸ªä¸€ä¸ªè¿æ¥è¯·æ±‚çš„æ—¶å€™ï¼Œå¯èƒ½è¿˜å­˜åœ¨å…¶å®ƒçš„è¿æ¥è¯·æ±‚ã€‚å› ä¸ºTCPè¿æ¥æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨ä¸€ç§åŠè¿æ¥çš„çŠ¶æ€ï¼Œæœ‰æ—¶ç”±äºåŒæ—¶å°è¯•è¿æ¥çš„ç”¨æˆ·è¿‡å¤šï¼Œä½¿å¾—æœåŠ¡å™¨è¿›ç¨‹æ— æ³•å¿«é€Ÿåœ°å®Œæˆè¿æ¥è¯·æ±‚ã€‚å¦‚æœè¿™ä¸ªæƒ…å†µå‡ºç°äº†ï¼ŒæœåŠ¡å™¨è¿›ç¨‹å¸Œæœ›å†…æ ¸å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå†…æ ¸ä¼šåœ¨è‡ªå·±çš„è¿›ç¨‹ç©ºé—´é‡Œç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ä»¥è·Ÿè¸ªè¿™äº›å®Œæˆçš„è¿æ¥ä½†æœåŠ¡å™¨è¿›ç¨‹è¿˜æ²¡æœ‰æ¥æ‰‹å¤„ç†æˆ–æ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼Œè¿™æ ·çš„ä¸€ä¸ªé˜Ÿåˆ—å†…æ ¸ä¸å¯èƒ½è®©å…¶ä»»æ„å¤§ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªå¤§å°çš„ä¸Šé™ã€‚è¿™ä¸ªbacklogå‘Šè¯‰å†…æ ¸ä½¿ç”¨è¿™ä¸ªæ•°å€¼ä½œä¸ºä¸Šé™ã€‚

æ¯«æ— ç–‘é—®ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä¸èƒ½éšä¾¿æŒ‡å®šä¸€ä¸ªæ•°å€¼ï¼Œå†…æ ¸æœ‰ä¸€ä¸ªè®¸å¯çš„èŒƒå›´ã€‚è¿™ä¸ªèŒƒå›´æ˜¯å®ç°ç›¸å…³çš„ã€‚å¾ˆéš¾æœ‰æŸç§ç»Ÿä¸€ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¼šå°30ä»¥å†…ã€‚

TCPçš„æœåŠ¡å™¨ç«¯socketåŸºæœ¬æµç¨‹socket-&gt;bind-&gt;listen-&gt;accept-&gt;send/recv-&gt;closesocketï¼Œå®¢æˆ·ç«¯åŸºæœ¬æµç¨‹socket-&gt;[bind-&gt;]-&gt;connect-&gt;send/recv-&gt;closesocketï¼Œå…¶ä¸­å®¢æˆ·ç«¯connectå‡½æ•°åº”è¯¥æ˜¯å’ŒæœåŠ¡å™¨ç«¯çš„listenå‡½æ•°ç›¸äº’ä½œç”¨ï¼Œè€Œä¸æ˜¯acceptå‡½æ•°ã€‚åœ¨listenå‡½æ•°ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°backlogä»£è¡¨ç€ç­‰å¾…å¤„ç†çš„è¿æ¥é˜Ÿåˆ—ï¼ˆä»¥ä¸‹ç®€ç§°é˜Ÿåˆ—ï¼‰çš„é•¿åº¦ï¼Œç¥é©¬æ„æ€ï¼Ÿæˆ‘ä¹Ÿä¸å¤ªæ‡‚ï¼Œä½†æ˜¯é€šè¿‡ä»£ç å®è·µï¼Œæˆ‘å¯ä»¥ç®€å•çš„è¯´ï¼Œæ¯å½“æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯connectäº†ï¼Œlistençš„é˜Ÿåˆ—ä¸­å°±åŠ å…¥ä¸€ä¸ªè¿æ¥ï¼Œæ¯å½“æœåŠ¡å™¨ç«¯acceptäº†ï¼Œå°±ä»listençš„é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥ï¼Œè½¬æˆä¸€ä¸ªä¸“é—¨ç”¨æ¥ä¼ è¾“æ•°æ®çš„socketï¼ˆacceptå‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨ç«¯ç¨‹åºä¸­æœ‰ä¸¤ä¸ªsocketï¼Œå‰è€…æ˜¯ç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„socket.
</code></pre><p>æœ€åè¿”å›è¿™ä¸ª socketï¼Œè‡³æ­¤ httpd å°±åˆå§‹åŒ–å®Œæˆäº†ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ª socketï¼Œç»‘å®šå¹¶ç›‘å¬æŒ‡å®š IP å’Œç«¯å£åè¿”å›è¿™ä¸ª socketã€‚</p>
<h3 id="accept-request-æ¥å—è¯·æ±‚"><a href="#accept-request-æ¥å—è¯·æ±‚" class="headerlink" title="accept_request æ¥å—è¯·æ±‚"></a><code>accept_request</code> æ¥å—è¯·æ±‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* A request has caused a call to accept() on the server port to</span></span><br><span class="line"><span class="comment"> * return.  Process the request appropriately.</span></span><br><span class="line"><span class="comment"> * Parameters: the socket connected to the client */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_request</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> client = (<span class="keyword">intptr_t</span>)arg;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">size_t</span> numchars;</span><br><span class="line">    <span class="keyword">char</span> method[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> url[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">size_t</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> cgi = <span class="number">0</span>;      <span class="comment">/* becomes true if server decides this is a CGI</span></span><br><span class="line"><span class="comment">                       * program */</span></span><br><span class="line">    <span class="keyword">char</span> *query_string = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//ä» socket ä¸­è¯»å–ä¸€è¡Œæ•°æ®ï¼Œè¿™é‡Œå°±æ˜¯è·å–é¦–è¡Œæ•°æ®</span></span><br><span class="line">    numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    i = <span class="number">0</span>; j = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å°†bufä¸­å»é™¤ç©ºç™½å­—ç¬¦åçš„æ•°æ®å­˜æ”¾åˆ° method ä¸­</span></span><br><span class="line">    <span class="keyword">while</span> (!ISspace(buf[i]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(method) - <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        method[i] = buf[i];</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//j ç”¨äºå­˜æ”¾ method ä¸­æœ€åä¸€ä¸ªå­—ç¬¦çš„ä½ç½®</span></span><br><span class="line">    j=i;</span><br><span class="line">    method[i] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœè¯·æ±‚æ–¹æ³•ä¸æ˜¯ GET æˆ– POSTï¼Œå°±è¿”å›ä¸€ä¸ª 501 é¡µé¢</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) &amp;&amp; strcasecmp(method, <span class="string">"POST"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        unimplemented(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ POST è¯·æ±‚ï¼Œå°±æ‰§è¡Œäº† cgi</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>)</span><br><span class="line">        cgi = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//è¿‡æ»¤ç©ºç™½å­—ç¬¦</span></span><br><span class="line">    <span class="keyword">while</span> (ISspace(buf[j]) &amp;&amp; (j &lt; numchars))</span><br><span class="line">        j++;</span><br><span class="line">    <span class="comment">//è·å– url</span></span><br><span class="line">    <span class="keyword">while</span> (!ISspace(buf[j]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(url) - <span class="number">1</span>) &amp;&amp; (j &lt; numchars))</span><br><span class="line">    &#123;</span><br><span class="line">        url[i] = buf[j];</span><br><span class="line">        i++; j++;</span><br><span class="line">    &#125;</span><br><span class="line">    url[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ GET è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        query_string = url;</span><br><span class="line">        <span class="keyword">while</span> ((*query_string != <span class="string">'?'</span>) &amp;&amp; (*query_string != <span class="string">'\0'</span>))</span><br><span class="line">            query_string++;</span><br><span class="line">        <span class="keyword">if</span> (*query_string == <span class="string">'?'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">            *query_string = <span class="string">'\0'</span>;</span><br><span class="line">            query_string++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®è¯·æ±‚é¡µé¢åœ°å€</span></span><br><span class="line">    <span class="built_in">sprintf</span>(path, <span class="string">"htdocs%s"</span>, url);</span><br><span class="line">    <span class="comment">//å¦‚æœé¡µé¢åœ°å€ä»¥ / ç»“å°¾ï¼Œå°±æ·»åŠ  index.html ä½œä¸ºé»˜è®¤è¯·æ±‚é¡µé¢</span></span><br><span class="line">    <span class="keyword">if</span> (path[<span class="built_in">strlen</span>(path) - <span class="number">1</span>] == <span class="string">'/'</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(path, <span class="string">"index.html"</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœ path åœ¨æœ¬åœ°ä¸å­˜åœ¨ï¼Œå°±å¿½ç•¥ client å‰©ä½™çš„å†…å®¹å¹¶æ˜¾ç¤º 404 é¡µé¢</span></span><br><span class="line">    <span class="keyword">if</span> (stat(path, &amp;st) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))  <span class="comment">/* read &amp; discard headers */</span></span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        not_found(client);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//å†æ¬¡åˆ¤æ–­ path å¦‚æœæ˜¯ç›®å½•ï¼Œå°±æ·»åŠ é»˜è®¤çš„ index.html ä½œä¸ºè¯·æ±‚é¡µé¢</span></span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IFMT) == S_IFDIR)</span><br><span class="line">            <span class="built_in">strcat</span>(path, <span class="string">"/index.html"</span>);</span><br><span class="line">        <span class="comment">//å¦‚æœ path æ–‡ä»¶å¯æ‰§è¡Œï¼Œå°±å°† cgi å˜é‡èµ‹å€¼ä¸º 1</span></span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IXUSR) ||</span><br><span class="line">                (st.st_mode &amp; S_IXGRP) ||</span><br><span class="line">                (st.st_mode &amp; S_IXOTH)    )</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ æ˜¯å¦æ‰§è¡Œ cgiæ–‡ä»¶å¦‚æœ cgi ä¸º 0 å°±æ‰§è¡ŒæœåŠ¡ç«¯æ–‡ä»¶ï¼Œå¦åˆ™æ‰§è¡Œå®¢æˆ·ç«¯æœ¬åœ° cgiã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!cgi)</span><br><span class="line">            serve_file(client, path);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            execute_cgi(client, path, method, query_string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å…³é—­ socket</span></span><br><span class="line">    close(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>accept_request</code> æ˜¯å¤„ç†è¯·æ±‚çš„ä¸»ä½“ï¼Œåœ¨æœåŠ¡ç«¯åˆå§‹åŒ– httpd åå¹¶æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å»ºç«‹äº† TCP è¿æ¥ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ä¿¡æ¯ï¼Œé€šè¿‡ <code>get_line</code> å‡½æ•°è·å–ä¸€è¡Œæ•°æ®å†…å®¹ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å­—ç¬¦ä¸²è§£æï¼Œè·å–å‡ºè¯·æ±‚ç±»å‹ã€URLç­‰ä¿¡æ¯ã€‚</p>
<p>æ ¹æ®è¯·æ±‚æ˜¯ <code>POST</code> è¿˜æ˜¯ <code>GET</code> åˆ†åˆ«è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ <code>htdocs</code> ç›®å½•ä¸‹çš„ index.html é¡µé¢ä½œä¸ºé»˜è®¤è¯·æ±‚é¡µé¢ï¼Œå¦‚æœè‡ªå·±æ‰‹åŠ¨æŒ‡å®šè¯·æ±‚é¡µé¢å°±ä»¥ç”¨æˆ·æŒ‡å®šé¡µé¢ä¸ºå‡†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>color.cgi</code> æ–‡ä»¶ã€‚</p>
<p>æœ€åæ ¹æ®è¯·æ±‚ç±»å‹ä»¥åŠ path æ–‡ä»¶çš„å¯æ‰§è¡Œæƒé™å†³å®šé‡‡ç”¨ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œ <code>serv_file</code> æ˜¯å°† path æ–‡ä»¶è¯»å–å±•ç¤ºåœ¨æµè§ˆå™¨ä¸Šï¼Œ<code>execute_cgi</code> æ˜¯æ‰§è¡Œæœ¬åœ°çš„ cgi æ–‡ä»¶ã€‚</p>
<p>ä¸Šé¢ç¨‹åºä¸­çš„ <code>ISspace</code> å‡½æ•°æ˜¯ç”¨äºåˆ¤æ–­ç©ºç™½å­—ç¬¦çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ISspace(x) isspace((int)(x))</span></span><br></pre></td></tr></table></figure>
<p><code>isspace</code> æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œç”¨äºæ£€æŸ¥å‚æ•°cæ˜¯å¦ä¸ºç©ºæ ¼å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºç©ºæ ¼(â€˜ â€˜)ã€æ°´å¹³å®šä½å­—ç¬¦<br>(â€˜\tâ€™)ã€å½’ä½é”®(â€˜\râ€™)ã€æ¢è¡Œ(â€˜\nâ€™)ã€å‚ç›´å®šä½å­—ç¬¦(â€˜\vâ€™)æˆ–ç¿»é¡µ(â€˜\fâ€™)çš„æƒ…å†µã€‚å¦‚æœæ˜¯ç©ºç™½å­—ç¬¦å°±è¿”å› TRUEï¼Œä¸æ˜¯ç©ºç™½å­—ç¬¦å°±è¿”å› NULLï¼›</p>
<h3 id="get-line-å‡½æ•°"><a href="#get-line-å‡½æ•°" class="headerlink" title="get_line å‡½æ•°"></a><code>get_line</code> å‡½æ•°</h3><p><code>get_line</code> å‡½æ•°å°±æ˜¯è¯»å–ä¸€è¡Œä»¥ <code>\r\n</code>ç»“å°¾çš„æ–‡æœ¬æ•°æ®ï¼Œè¿™æ˜¯åŸºæœ¬çš„å­—ç¬¦ä¸²å¤„ç†ç¨‹åºï¼Œäº†è§£å¥½æŒ‡é’ˆå’ŒåŸºæœ¬åº“å‡½æ•°çš„ä½¿ç”¨å°±æ¯”è¾ƒç®€å•äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Get a line from a socket, whether the line ends in a newline,</span></span><br><span class="line"><span class="comment"> * carriage return, or a CRLF combination.  Terminates the string read</span></span><br><span class="line"><span class="comment"> * with a null character.  If no newline indicator is found before the</span></span><br><span class="line"><span class="comment"> * end of the buffer, the string is terminated with a null.  If any of</span></span><br><span class="line"><span class="comment"> * the above three line terminators is read, the last character of the</span></span><br><span class="line"><span class="comment"> * string will be a linefeed and the string will be terminated with a</span></span><br><span class="line"><span class="comment"> * null character.</span></span><br><span class="line"><span class="comment"> * Parameters: the socket descriptor</span></span><br><span class="line"><span class="comment"> *             the buffer to save the data in</span></span><br><span class="line"><span class="comment"> *             the size of the buffer</span></span><br><span class="line"><span class="comment"> * Returns: the number of bytes stored (excluding null) */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_line</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((i &lt; size - <span class="number">1</span>) &amp;&amp; (c != <span class="string">'\n'</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//recv æ¥æ”¶ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®</span></span><br><span class="line">        n = recv(sock, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">/* DEBUG printf("%02X\n", c); */</span></span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœä»¥ \r ç»“å°¾ï¼Œå°±ç»§ç»­åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯ \n</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">'\r'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//é¢„è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œè¿™é‡Œä½¿ç”¨ MSG_PEEK çš„ä½œç”¨å°±æ˜¯é¢„è¯»å–ï¼Œä¸å½±å“ä¸‹æ¬¡recvæ¥æ”¶åˆ°çš„æ•°æ®</span></span><br><span class="line">                n = recv(sock, &amp;c, <span class="number">1</span>, MSG_PEEK);</span><br><span class="line">                <span class="comment">/* DEBUG printf("%02X\n", c); */</span></span><br><span class="line">                <span class="comment">//å¦‚æœè¯»å–åˆ°çš„æ˜¯ \nï¼Œå°±è¯»å– \n åˆ°å˜é‡ cï¼Œå¦åˆ™èµ‹å€¼å˜é‡c ä¸º \n</span></span><br><span class="line">                <span class="comment">//è¿™é‡Œä¸å¤ªæ˜ç™½ï¼Œä¸¤ç§æƒ…å†µä¸‹å˜é‡ c éƒ½è¢«èµ‹å€¼ä¸º \n äº†ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ</span></span><br><span class="line">                <span class="keyword">if</span> ((n &gt; <span class="number">0</span>) &amp;&amp; (c == <span class="string">'\n'</span>))</span><br><span class="line">                    recv(sock, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    c = <span class="string">'\n'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//èµ‹å€¼buf[i]</span></span><br><span class="line">            buf[i] = c;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            c = <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buf[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="unimplemented-å’Œ-not-found-å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å›-501-é¡µé¢å’Œ-404-é¡µé¢"><a href="#unimplemented-å’Œ-not-found-å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å›-501-é¡µé¢å’Œ-404-é¡µé¢" class="headerlink" title="unimplemented å’Œ not_found å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å› 501 é¡µé¢å’Œ 404 é¡µé¢"></a><code>unimplemented</code> å’Œ <code>not_found</code> å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å› 501 é¡µé¢å’Œ 404 é¡µé¢</h3><p><code>unimplemented</code> ç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ–¹æ³•æœªå®ç°çš„é¡µé¢ä¿¡æ¯ï¼Œå…·ä½“å†…å®¹å°±æ˜¯ <code>send</code> å‡½æ•°å‘é€çš„é‚£äº›å­—ç¬¦ä¸²ã€‚</p>
<p>è¿™é‡Œåªæœ‰ä¸€ä¸ª <code>send</code> å‡½æ•°éœ€è¦ç•™æ„ï¼Œ<code>send</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Inform the client that the requested web method has not been</span></span><br><span class="line"><span class="comment"> * implemented.</span></span><br><span class="line"><span class="comment"> * Parameter: the client socket */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unimplemented</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 501 Method Not Implemented\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, SERVER_STRING);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Method Not Implemented\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;/TITLE&gt;&lt;/HEAD&gt;\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;BODY&gt;&lt;P&gt;HTTP request method not supported.\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;/BODY&gt;&lt;/HTML&gt;\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒç† <code>not_found</code> è¿”å› 404 é¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Give a client a 404 not found status message. */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">not_found</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 404 NOT FOUND\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, SERVER_STRING);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;HTML&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;BODY&gt;&lt;P&gt;The server could not fulfill\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"your request because the resource specified\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"is unavailable or nonexistent.\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"&lt;/BODY&gt;&lt;/HTML&gt;\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="serv-file-è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯"><a href="#serv-file-è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯" class="headerlink" title="serv_file è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯"></a><code>serv_file</code> è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Send a regular file to the client.  Use headers, and report</span></span><br><span class="line"><span class="comment"> * errors to client if they occur.</span></span><br><span class="line"><span class="comment"> * Parameters: a pointer to a file structure produced from the socket</span></span><br><span class="line"><span class="comment"> *              file descriptor</span></span><br><span class="line"><span class="comment"> *             the name of the file to serve */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serve_file</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *resource = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'A'</span>; buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="comment">//å°† client ä¸­çš„æ•°æ®éƒ½è¯»å‡ºæ¥ï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œç›¸å½“äºä¸¢å¼ƒ</span></span><br><span class="line">    <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))  <span class="comment">/* read &amp; discard headers */</span></span><br><span class="line">        numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="comment">//è¯»å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    resource = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="literal">NULL</span>)</span><br><span class="line">        not_found(client);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">//å‘é€å¤´æ•°æ®ä¿¡æ¯</span></span><br><span class="line">        headers(client, filename);</span><br><span class="line">        <span class="comment">//å‘é€æ–‡ä»¶å†…å®¹</span></span><br><span class="line">        cat(client, resource);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®æ—¶éœ€è¦å…ˆä½¿ç”¨ <code>headers</code> ç»„ç»‡æ•°æ®å¤´ä¿¡æ¯ï¼Œç„¶åå‘é€æ–‡ä»¶å†…å®¹ã€‚</p>
<ul>
<li><p>headers å‡½æ•°</p>
<p>  å¾ˆç®€å•ï¼Œæ²¡ä»€ä¹ˆè¯´çš„ï¼Œå°±æ˜¯å‘é€ä¸€äº›å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œç”¨äºæ ‡ç¤º HTTP å¤´éƒ¨ä¿¡æ¯ã€‚</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Return the informational HTTP headers about a file. */</span></span><br><span class="line"><span class="comment">/* Parameters: the socket to print the headers on</span></span><br><span class="line"><span class="comment">*             the name of the file */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">headers</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">//å¯ä»¥æ ¹æ®æ–‡ä»¶åç¡®å®šæ–‡ä»¶ç±»å‹</span></span><br><span class="line">    (<span class="keyword">void</span>)filename;  <span class="comment">/* could use filename to determine file type */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, SERVER_STRING);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>cat</code> å‘é€æ–‡ä»¶å†…å®¹</p>
<p>  <code>cat</code> å‡½æ•°ç”¨äºå‘é€æ–‡ä»¶å†…å®¹åˆ°å®¢æˆ·ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Put the entire contents of a file out on a socket.  This function</span></span><br><span class="line"><span class="comment">* is named after the UNIX "cat" command, because it might have been</span></span><br><span class="line"><span class="comment">* easier just to do something like pipe, fork, and exec("cat").</span></span><br><span class="line"><span class="comment">* Parameters: the client socket descriptor</span></span><br><span class="line"><span class="comment">*             FILE pointer for the file to cat */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cat</span><span class="params">(<span class="keyword">int</span> client, FILE *resource)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    fgets(buf, <span class="keyword">sizeof</span>(buf), resource);</span><br><span class="line">    <span class="keyword">while</span> (!feof(resource))</span><br><span class="line">    &#123;</span><br><span class="line">        send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">        fgets(buf, <span class="keyword">sizeof</span>(buf), resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="execute-cgi-æ‰§è¡Œ-cgi-æ–‡ä»¶"><a href="#execute-cgi-æ‰§è¡Œ-cgi-æ–‡ä»¶" class="headerlink" title="execute_cgi æ‰§è¡Œ cgi æ–‡ä»¶"></a><code>execute_cgi</code> æ‰§è¡Œ cgi æ–‡ä»¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="comment">/* Execute a CGI script.  Will need to set environment variables as</span></span><br><span class="line"><span class="comment"> * appropriate.</span></span><br><span class="line"><span class="comment"> * Parameters: client socket descriptor</span></span><br><span class="line"><span class="comment"> *             path to the CGI script */</span></span><br><span class="line"><span class="comment">/**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute_cgi</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *method, <span class="keyword">const</span> <span class="keyword">char</span> *query_string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_output[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_input[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> content_length = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®é»˜è®¤ buf å€¼</span></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'M'</span>; buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ GET æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//è¿‡æ»¤å¤´éƒ¨ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))  <span class="comment">/* read &amp; discard headers */</span></span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ POST æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>) <span class="comment">/*POST*/</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è·å–ä¸€è¡Œæ•°æ®</span></span><br><span class="line">        numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))</span><br><span class="line">        &#123;</span><br><span class="line">            buf[<span class="number">15</span>] = <span class="string">'\0'</span>;</span><br><span class="line">            <span class="comment">//è·å– Content-Length å¤§å°</span></span><br><span class="line">            <span class="keyword">if</span> (strcasecmp(buf, <span class="string">"Content-Length:"</span>) == <span class="number">0</span>)</span><br><span class="line">                content_length = atoi(&amp;(buf[<span class="number">16</span>]));</span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœè·å–ä¸åˆ° Content-Length å°±è¡¨ç¤ºè¯·æ±‚å‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> (content_length == <span class="number">-1</span>) &#123;</span><br><span class="line">            bad_request(client);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">/*HEAD or other*/</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºç®¡é“</span></span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_output) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_input) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> ( (pid = fork()) &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘é€ 200 OK ä¿¡æ¯ç»™å®¢æˆ·ç«¯è¡¨ç¤ºè¯·æ±‚è¢«æˆåŠŸå¤„ç†</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//å­è¿›ç¨‹æ‰§è¡Œ cgi è„šæœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)  <span class="comment">/* child: CGI script */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> meth_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> query_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> length_env[<span class="number">255</span>];</span><br><span class="line">        <span class="comment">//å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œå°† cgi_output[1]é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œcgi_input[0]é‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥</span></span><br><span class="line">        dup2(cgi_output[<span class="number">1</span>], STDOUT);</span><br><span class="line">        dup2(cgi_input[<span class="number">0</span>], STDIN);</span><br><span class="line">        close(cgi_output[<span class="number">0</span>]);</span><br><span class="line">        close(cgi_input[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">sprintf</span>(meth_env, <span class="string">"REQUEST_METHOD=%s"</span>, method);</span><br><span class="line">        putenv(meth_env);</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(query_env, <span class="string">"QUERY_STRING=%s"</span>, query_string);</span><br><span class="line">            putenv(query_env);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;   <span class="comment">/* POST */</span></span><br><span class="line">            <span class="built_in">sprintf</span>(length_env, <span class="string">"CONTENT_LENGTH=%d"</span>, content_length);</span><br><span class="line">            putenv(length_env);</span><br><span class="line">        &#125;</span><br><span class="line">        execl(path, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">/* parent */</span></span><br><span class="line">        close(cgi_output[<span class="number">1</span>]);</span><br><span class="line">        close(cgi_input[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; content_length; i++) &#123;</span><br><span class="line">                recv(client, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                write(cgi_input[<span class="number">1</span>], &amp;c, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">while</span> (read(cgi_output[<span class="number">0</span>], &amp;c, <span class="number">1</span>) &gt; <span class="number">0</span>)</span><br><span class="line">            send(client, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        close(cgi_output[<span class="number">0</span>]);</span><br><span class="line">        close(cgi_input[<span class="number">1</span>]);</span><br><span class="line">        waitpid(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>execute_cgi</code> å…ˆä» client socket ä¸­ç»§ç»­è¯»å–æ•°æ®ï¼Œåˆ¤æ–­ <code>Content-Length</code> çš„å¤§å°æ˜¯æ­£ç¡®ï¼Œç„¶ååˆ›å»ºç®¡é“ã€‚</p>
<p>ç®¡é“æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸¤ä¸ªç®¡é“ <code>cgi_input</code> å’Œ <code>cgi_output</code>ï¼Œå¹¶ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ã€‚</p>
<p>åœ¨å­è¿›ç¨‹ä¸­ï¼ŒæŠŠ STDOUT é‡å®šå‘åˆ° cgi_outputt çš„å†™å…¥ç«¯ï¼ŒæŠŠ STDIN é‡å®šå‘åˆ° cgi_input çš„è¯»å–ç«¯ï¼Œå…³é—­ cgi_input çš„å†™å…¥ç«¯ å’Œ cgi_output çš„è¯»å–ç«¯ï¼Œè®¾ç½® request_method çš„ç¯å¢ƒå˜é‡ï¼ŒGET çš„è¯è®¾ç½® query_string çš„ç¯å¢ƒå˜é‡ï¼ŒPOST çš„è¯è®¾ç½® content_length çš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›ç¯å¢ƒå˜é‡éƒ½æ˜¯ä¸ºäº†ç»™ cgi è„šæœ¬è°ƒç”¨ï¼Œæ¥ç€ç”¨ execl è¿è¡Œ cgi ç¨‹åºã€‚</p>
<p>åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œå…³é—­ cgi_input çš„è¯»å–ç«¯ å’Œ cgi_output çš„å†™å…¥ç«¯ï¼Œå¦‚æœ POST çš„è¯ï¼ŒæŠŠ POST æ•°æ®å†™å…¥ cgi_inputï¼Œå·²è¢«é‡å®šå‘åˆ° STDINï¼Œè¯»å– cgi_output çš„ç®¡é“è¾“å‡ºåˆ°å®¢æˆ·ç«¯ï¼Œè¯¥ç®¡é“è¾“å…¥æ˜¯ STDOUTã€‚æ¥ç€å…³é—­æ‰€æœ‰ç®¡é“ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚</p>
<p>ç”¨å›¾è¡¨ç¤ºå‡ºæ¥å°±æ˜¯ï¼š</p>
<p>å›¾1 ç®¡é“åˆå§‹çŠ¶æ€ï¼š</p>
<p><img src="https://camo.githubusercontent.com/cd2c864c743f7135829e728efc15d4e16af1bc71/687474703a2f2f696d672e626c6f672e6373646e2e6e65742f32303134313232363137333232323735303f77617465726d61726b2f322f746578742f6148523063446f764c324a736232637559334e6b626935755a585176616d4e71597a6b784f413d3d2f666f6e742f3561364c354c32542f666f6e7473697a652f3430302f66696c6c2f49304a42516b46434d413d3d2f646973736f6c76652f37302f677261766974792f43656e746572" alt="pipe1"></p>
<p>å›¾2 ç®¡é“æœ€ç»ˆçŠ¶æ€ï¼š</p>
<p><img src="https://camo.githubusercontent.com/ddc3e769843c534bcecf8b9c191f4d923c5190a3/687474703a2f2f696d672e626c6f672e6373646e2e6e65742f32303134313232363136313131393938313f77617465726d61726b2f322f746578742f6148523063446f764c324a736232637559334e6b626935755a585176616d4e71597a6b784f413d3d2f666f6e742f3561364c354c32542f666f6e7473697a652f3430302f66696c6c2f49304a42516b46434d413d3d2f646973736f6c76652f37302f677261766974792f43656e746572" alt="pipe2"></p>
<p>å›¾ç‰‡ç›´è§‚åœ°æ˜¾ç¤ºäº† GET å’Œ POST è¯·æ±‚é€šè¿‡ç®¡é“å°†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯æµè§ˆå™¨çš„è¿‡ç¨‹ã€‚</p>
<p>è¿˜æœ‰ä¸€å¼ å›¾ç‰‡æè¿°äº† execute_cgi çš„æ•´ä¸ªæµç¨‹ï¼š</p>
<p><img src="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/execute_cgi.png" alt="execute_cgi"></p>
<p>è¿™é‡Œé‡ç‚¹å…³æ³¨ä¸€ä¸‹ç®¡é“çš„æ¦‚å¿µå’Œä½¿ç”¨æ–¹å¼ã€‚</p>
<h2 id="ç½‘ç»œæŠ“åŒ…"><a href="#ç½‘ç»œæŠ“åŒ…" class="headerlink" title="ç½‘ç»œæŠ“åŒ…"></a>ç½‘ç»œæŠ“åŒ…</h2><p>åœ¨è¿è¡Œ httpd æœåŠ¡ç«¯åæ‰“å¼€ wireshark æŠ“åŒ…çœ‹ä¸€ä¸‹å…·ä½“çš„æ•°æ®ä¿¡æ¯ï¼›åœ¨è¾“å…¥é¢œè‰²æäº¤åï¼Œå¯ä»¥æŠ“å–åˆ°å¦‚ä¸‹æ•°æ®ï¼š</p>
<p><img src="https://github.com/jiaoqiyuan/pics/raw/master/blog/tinyhttpd/httpwireshark.png" alt="wireshark"></p>
<p>æ‰§è¡Œæäº¤åå®¢æˆ·ç«¯å‘æµè§ˆå™¨å‘é€äº†ä¸€ä¸ª POST è¯·æ±‚ï¼Œé™„å¸¦æœ‰é¢œè‰²ä¿¡æ¯ã€‚</p>
<p>å…¶å®å‘å‰å€’è¿˜èƒ½çœ‹åˆ°å»ºç«‹è¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ä¿¡æ¯ï¼Œä»¥åŠæœåŠ¡ç«¯è¿”å›çš„ 200 OK çš„æˆåŠŸä¿¡æ¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ°è¿™é‡Œæºç å°±åˆ†æå®Œäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°ç½‘ç»œçš„è¿æ¥å»ºç«‹ï¼Œç½‘ç»œæ•°æ®çš„æ”¶å‘ï¼Œcgi ç¨‹åºçš„è¿è¡Œï¼Œæµè§ˆå™¨é¡µé¢çš„å±•ç¤ºç­‰å†…å®¹ï¼›æœ‰ä¸€äº›å­—ç¬¦ä¸²çš„å¤„ç†ï¼Œç®¡é“çš„ä½¿ç”¨ï¼Œéå¸¸çŸ­å°ç²¾æ‚ï¼Œå€¼å¾—å¥½å¥½å­¦ä¹ ä¸€äº›ã€‚</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/C/" rel="tag"># C</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/21/vim-plugins/" rel="next" title="Vimæ’ä»¶é…ç½®">
                <i class="fa fa-chevron-left"></i> Vimæ’ä»¶é…ç½®
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/06/git-worktrees/" rel="prev" title="Git WorkTreesï¼šä½ ä»æœªå¬è¯´è¿‡çš„ Git æœ€ä½³ç‰¹æ€§ - è¯‘">
                Git WorkTreesï¼šä½ ä»æœªå¬è¯´è¿‡çš„ Git æœ€ä½³ç‰¹æ€§ - è¯‘ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar-6.png" alt="Jony Chiao">
            
              <p class="site-author-name" itemprop="name">Jony Chiao</p>
              <p class="site-description motion-element" itemprop="description">bulabula</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">79</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jiaoqiyuan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jijujiu@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•ˆæœæ¼”ç¤º"><span class="nav-number">1.</span> <span class="nav-text">æ•ˆæœæ¼”ç¤º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æºç è§£æ"><span class="nav-number">2.</span> <span class="nav-text">æºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-å‡½æ•°å…¥æ‰‹"><span class="nav-number">2.1.</span> <span class="nav-text">main å‡½æ•°å…¥æ‰‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startup-åˆå§‹åŒ–-httpd-æœåŠ¡"><span class="nav-number">2.2.</span> <span class="nav-text">startup åˆå§‹åŒ– httpd æœåŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#accept-request-æ¥å—è¯·æ±‚"><span class="nav-number">2.3.</span> <span class="nav-text">accept_request æ¥å—è¯·æ±‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-line-å‡½æ•°"><span class="nav-number">2.4.</span> <span class="nav-text">get_line å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unimplemented-å’Œ-not-found-å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å›-501-é¡µé¢å’Œ-404-é¡µé¢"><span class="nav-number">2.5.</span> <span class="nav-text">unimplemented å’Œ not_found å‡½æ•°åˆ†åˆ«ç”¨äºè¿”å› 501 é¡µé¢å’Œ 404 é¡µé¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serv-file-è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯"><span class="nav-number">2.6.</span> <span class="nav-text">serv_file è¿”å›æ–‡ä»¶å†…å®¹ç»™å®¢æˆ·ç«¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#execute-cgi-æ‰§è¡Œ-cgi-æ–‡ä»¶"><span class="nav-number">2.7.</span> <span class="nav-text">execute_cgi æ‰§è¡Œ cgi æ–‡ä»¶</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç½‘ç»œæŠ“åŒ…"><span class="nav-number">3.</span> <span class="nav-text">ç½‘ç»œæŠ“åŒ…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">4.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jony Chiao</span>

  
</div>





        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> è®¿é—®äººæ•°
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> è®¿é—®æ€»é‡
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'n2HspM41RbogfYToohbhdzcF-gzGzoHsz',
        appKey: 'BmbN7noqgmLyN99xJLQfDwYv',
        placeholder: 'ãƒ¾ï¾‰â‰§âˆ€â‰¦)oæ¥å•Šï¼Œå¿«æ´»å•Š!',
        avatar:'retro',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
